{% extends 'core/base.html' %}

{% block title %}Licenses - FishTech{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2>Business Licenses</h2>
            
            <div class="mb-3">
                <a href="{% url 'documents_home' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Documents Home
                </a>
            </div>

            <!-- Upload Section -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="mb-3">
                        <input type="file" id="fileInput" accept="image/*,.pdf" multiple style="display: none;">
                        <button type="button" id="uploadBtn" class="btn btn-primary btn-lg">
                            <i class="bi bi-upload"></i> Select Files to Upload
                        </button>
                        <span id="uploadStatus" class="ms-3"></span>
                    </div>
                    
                    <div id="dropZone">
                        <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
                        <p class="mb-0">Or drag and drop files here</p>
                        <small class="text-muted">Images and PDFs (multiple files supported)</small>
                    </div>
                </div>
            </div>

            <!-- Files Grid -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Uploaded Licenses</h5>
                    <select class="form-select form-select-sm" id="companyFilter" style="width: 200px;">
                        <option value="">All Companies</option>
                    </select>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Company</th>
                                <th>Filename</th>
                                <th>Issuance Date</th>
                                <th>Expiration Date</th>
                                <th>Managing User</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="filesTableBody">
                            <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add License</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">File</label>
                    <div id="uploadFileName" class="form-control bg-light"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Title <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="uploadTitle" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Company</label>
                    <select class="form-select" id="uploadCompany">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Issuance Date</label>
                    <input type="date" class="form-control" id="uploadIssuanceDate">
                </div>
                <div class="mb-3">
                    <label class="form-label">Expiration Date</label>
                    <input type="date" class="form-control" id="uploadExpirationDate">
                </div>
                <div class="mb-3">
                    <label class="form-label">Managing User</label>
                    <select class="form-select" id="uploadManagingUser">
                        <option value="">-- Select Company First --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitUploadBtn">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit License</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editLicenseId">
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="editTitle">
                </div>
                <div class="mb-3">
                    <label class="form-label">Company</label>
                    <select class="form-select" id="editCompany">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Issuance Date</label>
                    <input type="date" class="form-control" id="editIssuanceDate">
                </div>
                <div class="mb-3">
                    <label class="form-label">Expiration Date</label>
                    <input type="date" class="form-control" id="editExpirationDate">
                </div>
                <div class="mb-3">
                    <label class="form-label">Managing User</label>
                    <select class="form-select" id="editManagingUser">
                        <option value="">-- Select Company First --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLicense()">Save</button>
            </div>
        </div>
    </div>
</div>

<style>
#dropZone {
    border: 2px dashed #ccc;
    padding: 40px;
    text-align: center;
    border-radius: 5px;
    transition: all 0.3s ease;
    cursor: pointer;
}
#dropZone.dragover {
    border-color: #007bff;
    background-color: #f0f7ff;
}
.expiring-soon {
    background-color: #fff3cd !important;
}
.expired {
    background-color: #f8d7da !important;
}
.badge {
    font-size: 0.75em;
    vertical-align: middle;
    margin-left: 5px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';
    
    var usersCache = [];
    var companiesCache = [];
    var userCompaniesCache = {};
    var pendingFiles = [];
    var currentFileIndex = 0;
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    function init() {
        var fileInput = document.getElementById('fileInput');
        var uploadBtn = document.getElementById('uploadBtn');
        var dropZone = document.getElementById('dropZone');
        
        if (!fileInput || !uploadBtn || !dropZone) return;
        
        uploadBtn.addEventListener('click', function() { fileInput.click(); });
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                pendingFiles = Array.from(this.files);
                currentFileIndex = 0;
                showUploadModal();
            }
        });
        
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                pendingFiles = Array.from(e.dataTransfer.files);
                currentFileIndex = 0;
                showUploadModal();
            }
        });
        dropZone.addEventListener('click', function() { fileInput.click(); });
        
        document.getElementById('submitUploadBtn').addEventListener('click', submitUpload);
        
        // Company change handlers for filtering users
        document.getElementById('uploadCompany').addEventListener('change', function() {
            populateUserDropdown('uploadManagingUser', this.value);
        });
        document.getElementById('editCompany').addEventListener('change', function() {
            populateUserDropdown('editManagingUser', this.value);
        });
        
        // Company filter for table
        document.getElementById('companyFilter').addEventListener('change', filterTable);
        
        document.getElementById('uploadModal').addEventListener('hidden.bs.modal', function() {
            if (currentFileIndex >= pendingFiles.length) {
                pendingFiles = [];
                currentFileIndex = 0;
                document.getElementById('fileInput').value = '';
            }
            document.getElementById('uploadTitle').value = '';
            document.getElementById('uploadCompany').value = '';
            document.getElementById('uploadIssuanceDate').value = '';
            document.getElementById('uploadExpirationDate').value = '';
            document.getElementById('uploadManagingUser').value = '';
            document.getElementById('uploadManagingUser').innerHTML = '<option value="">-- Select Company First --</option>';
        });
        
        loadFiles();
    }
    
    function populateUserDropdown(selectId, companyId) {
        var select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Select --</option>';
        
        if (!companyId) {
            select.innerHTML = '<option value="">-- Select Company First --</option>';
            return;
        }
        
        // Filter users by company
        usersCache.forEach(function(u) {
            var userCompanyIds = userCompaniesCache[u.id] || [];
            if (userCompanyIds.includes(parseInt(companyId))) {
                select.innerHTML += '<option value="' + u.id + '">' + escapeHtml(u.name) + '</option>';
            }
        });
        
        // If no users found for company, show all users
        if (select.options.length === 1) {
            usersCache.forEach(function(u) {
                select.innerHTML += '<option value="' + u.id + '">' + escapeHtml(u.name) + '</option>';
            });
        }
    }
    
    function populateCompanyDropdowns() {
        var selects = ['uploadCompany', 'editCompany', 'companyFilter'];
        selects.forEach(function(selectId) {
            var select = document.getElementById(selectId);
            var currentValue = select.value;
            
            if (selectId === 'companyFilter') {
                select.innerHTML = '<option value="">All Companies</option>';
            } else {
                select.innerHTML = '<option value="">-- Select --</option>';
            }
            
            companiesCache.forEach(function(c) {
                select.innerHTML += '<option value="' + c.id + '">' + escapeHtml(c.name) + '</option>';
            });
            
            if (currentValue) select.value = currentValue;
        });
    }
    
    function showUploadModal() {
        if (currentFileIndex >= pendingFiles.length) {
            loadFiles();
            return;
        }
        
        var file = pendingFiles[currentFileIndex];
        var remaining = pendingFiles.length - currentFileIndex;
        
        var counterText = remaining > 1 ? ' (' + (currentFileIndex + 1) + ' of ' + pendingFiles.length + ')' : '';
        document.getElementById('uploadFileName').textContent = file.name + counterText;
        
        var titleWithoutExt = file.name.replace(/\.[^/.]+$/, '');
        document.getElementById('uploadTitle').value = titleWithoutExt;
        
        var btn = document.getElementById('submitUploadBtn');
        btn.textContent = remaining > 1 ? 'Upload & Next' : 'Upload';
        
        var modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
        if (!modal) {
            modal = new bootstrap.Modal(document.getElementById('uploadModal'));
        }
        modal.show();
    }
    
    function submitUpload() {
        var title = document.getElementById('uploadTitle').value.trim();
        
        if (!title) {
            alert('Title is required');
            return;
        }
        if (currentFileIndex >= pendingFiles.length) {
            alert('No file selected');
            return;
        }
        
        var pendingFile = pendingFiles[currentFileIndex];
        var cleanName = pendingFile.name.replace(/[^a-zA-Z0-9\s._-]/g, '').replace(/\s+/g, ' ').trim();
        if (!cleanName || cleanName === '.') cleanName = 'file.' + (pendingFile.name.split('.').pop() || 'file');
        
        var cleanFile = new File([pendingFile], cleanName, {type: pendingFile.type});
        var formData = new FormData();
        formData.append('file', cleanFile);
        formData.append('title', title);
        formData.append('company_id', document.getElementById('uploadCompany').value);
        formData.append('issuance_date', document.getElementById('uploadIssuanceDate').value);
        formData.append('expiration_date', document.getElementById('uploadExpirationDate').value);
        formData.append('managing_user_id', document.getElementById('uploadManagingUser').value);
        
        var btn = document.getElementById('submitUploadBtn');
        btn.disabled = true;
        btn.textContent = 'Uploading...';
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/documents/licenses/upload/', true);
        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
        
        xhr.onload = function() {
            btn.disabled = false;
            
            if (xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                if (data.success) {
                    currentFileIndex++;
                    
                    document.getElementById('uploadTitle').value = '';
                    document.getElementById('uploadCompany').value = '';
                    document.getElementById('uploadIssuanceDate').value = '';
                    document.getElementById('uploadExpirationDate').value = '';
                    document.getElementById('uploadManagingUser').value = '';
                    document.getElementById('uploadManagingUser').innerHTML = '<option value="">-- Select Company First --</option>';
                    
                    if (currentFileIndex < pendingFiles.length) {
                        showUploadModal();
                    } else {
                        bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                        pendingFiles = [];
                        currentFileIndex = 0;
                        loadFiles();
                    }
                } else {
                    alert('Error: ' + data.error);
                    btn.textContent = pendingFiles.length - currentFileIndex > 1 ? 'Upload & Next' : 'Upload';
                }
            } else {
                alert('Upload failed');
                btn.textContent = pendingFiles.length - currentFileIndex > 1 ? 'Upload & Next' : 'Upload';
            }
        };
        xhr.onerror = function() {
            btn.disabled = false;
            btn.textContent = pendingFiles.length - currentFileIndex > 1 ? 'Upload & Next' : 'Upload';
            alert('Network error');
        };
        xhr.send(formData);
    }
    
    function loadFiles() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/documents/licenses/', true);
        
        xhr.onload = function() {
            var tbody = document.getElementById('filesTableBody');
            
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    usersCache = data.users || [];
                    companiesCache = data.companies || [];
                    userCompaniesCache = data.user_companies || {};
                    
                    populateCompanyDropdowns();
                    
                    if (!data.files || data.files.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No files uploaded yet</td></tr>';
                        return;
                    }
                    
                    var today = new Date();
                    var thirtyDays = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
                    
                    var html = '';
                    data.files.forEach(function(file) {
                        var rowClass = '';
                        if (file.expiration_date) {
                            var exp = new Date(file.expiration_date);
                            if (exp < today) rowClass = 'expired';
                            else if (exp < thirtyDays) rowClass = 'expiring-soon';
                        }
                        
                        html += '<tr class="' + rowClass + '" data-company-id="' + (file.company_id || '') + '">';
                        html += '<td>' + escapeHtml(file.title || '-') + '</td>';
                        html += '<td>' + escapeHtml(file.company_name || '-') + '</td>';
                        html += '<td><a href="' + file.url + '" target="_blank">' + escapeHtml(file.filename) + '</a></td>';
                        html += '<td>' + (file.issuance_date || '-') + '</td>';
                        html += '<td>';
                        if (file.expiration_date) {
                            html += file.expiration_date;
                            var exp = new Date(file.expiration_date);
                            if (exp < today) {
                                html += ' <span class="badge bg-danger">Expired</span>';
                            } else if (exp < thirtyDays) {
                                var daysLeft = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
                                html += ' <span class="badge bg-warning text-dark">' + daysLeft + ' days</span>';
                            }
                        } else {
                            html += '-';
                        }
                        html += '</td>';
                        html += '<td>' + escapeHtml(file.managing_user_name || '-') + '</td>';
                        html += '<td>';
                        html += '<button class="btn btn-sm btn-outline-primary me-1" onclick="editLicense(' + file.id + ', ' + JSON.stringify(file).replace(/"/g, '&quot;') + ')"><i class="bi bi-pencil"></i></button>';
                        html += '<button class="btn btn-sm btn-outline-danger" onclick="deleteLicenseFile(\'' + escapeHtml(file.filename) + '\')"><i class="bi bi-trash"></i></button>';
                        html += '</td>';
                        html += '</tr>';
                    });
                    tbody.innerHTML = html;
                } catch (e) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading files</td></tr>';
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading files</td></tr>';
            }
        };
        xhr.send();
    }
    
    function filterTable() {
        var filter = document.getElementById('companyFilter').value;
        var rows = document.querySelectorAll('#filesTableBody tr');
        
        rows.forEach(function(row) {
            if (!filter) {
                row.style.display = '';
            } else {
                var companyId = row.getAttribute('data-company-id');
                row.style.display = (companyId === filter) ? '' : 'none';
            }
        });
    }
    
    window.editLicense = function(id, file) {
        document.getElementById('editLicenseId').value = id;
        document.getElementById('editTitle').value = file.title || '';
        document.getElementById('editCompany').value = file.company_id || '';
        document.getElementById('editIssuanceDate').value = file.issuance_date || '';
        document.getElementById('editExpirationDate').value = file.expiration_date || '';
        
        // Populate user dropdown based on company
        populateUserDropdown('editManagingUser', file.company_id);
        
        // Set user value after dropdown is populated
        setTimeout(function() {
            document.getElementById('editManagingUser').value = file.managing_user_id || '';
        }, 50);
        
        new bootstrap.Modal(document.getElementById('editModal')).show();
    };
    
    window.saveLicense = function() {
        var id = document.getElementById('editLicenseId').value;
        var data = {
            title: document.getElementById('editTitle').value,
            company_id: document.getElementById('editCompany').value || null,
            issuance_date: document.getElementById('editIssuanceDate').value || null,
            expiration_date: document.getElementById('editExpirationDate').value || null,
            managing_user_id: document.getElementById('editManagingUser').value || null
        };
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/documents/licenses/' + id + '/update/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                loadFiles();
            } else {
                alert('Error saving');
            }
        };
        xhr.send(JSON.stringify(data));
    };
    
    window.deleteLicenseFile = function(filename) {
        if (!confirm('Delete ' + filename + '?')) return;
        
        var xhr = new XMLHttpRequest();
        xhr.open('DELETE', '/api/documents/licenses/delete/' + encodeURIComponent(filename) + '/', true);
        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
        
        xhr.onload = function() {
            if (xhr.status === 200) loadFiles();
            else alert('Delete failed');
        };
        xhr.send();
    };
    
    function getCookie(name) {
        var value = '; ' + document.cookie;
        var parts = value.split('; ' + name + '=');
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
    }
    
    function escapeHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
})();
</script>
{% endblock %}