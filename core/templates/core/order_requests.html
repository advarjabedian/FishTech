{% extends 'core/base.html' %}

{% block title %}Order Requests - FishTeck{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Filter Selection View -->
    <div id="filter-view">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-3">
                <h2 class="mb-0"><i class="bi bi-envelope-paper me-2"></i>Order Requests</h2>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span id="lastRefresh" class="text-muted small"></span>
                <button class="btn btn-primary" onclick="checkEmails(event)">
                    <i class="bi bi-envelope-arrow-down me-1"></i>Check Emails
                </button>
            </div>
        </div>
        
        <!-- KPIs -->
        <div class="row mb-4 justify-content-center">
            <div class="col-auto">
                <div class="d-flex">
                    <div class="bg-danger text-white d-flex" style="border-radius: 8px 0 0 8px; overflow: hidden;">
                        <div style="cursor: pointer; padding: 15px 40px;" onclick="selectFilter('incomplete')">
                            <div class="fw-bold">Incomplete</div>
                            <div style="font-size: 2rem; font-weight: bold;" id="kpi-incomplete">0</div>
                        </div>
                        <div style="width: 2px; background: rgba(255,255,255,0.3); align-self: stretch; margin: 10px 0;"></div>
                        <div style="cursor: pointer; padding: 15px 40px;" onclick="selectFilter('unassigned')">
                            <div class="fw-bold">Unassigned</div>
                            <div style="font-size: 2rem; font-weight: bold;" id="kpi-unassigned">0</div>
                        </div>
                    </div>
                    <div class="bg-success text-white" style="cursor: pointer; padding: 15px 40px; border-radius: 0 8px 8px 0; margin-left: 20px;" onclick="loadComplete()">
                        <div class="fw-bold">Complete</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="kpi-complete">...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filter List -->
        <div class="row mb-3 justify-content-center">
            <div class="col-lg-8 col-md-10 col-12">
                <div class="list-group" id="filter-list"></div>
            </div>
        </div>
    </div>

    <!-- Messages View (hidden by default) -->
    <div id="messages-view" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-outline-secondary" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <h4 class="mb-0" id="messages-header">Order Requests</h4>
            </div>
            <button class="btn btn-primary" onclick="checkEmails(event)">
                <i class="bi bi-envelope-arrow-down me-1"></i>Check Emails
            </button>
        </div>
        
        <!-- Messages Grid -->
        <div class="card">
            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0 table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Source</th>
                            <th>From</th>
                            <th>Subject</th>
                            <th>Customer</th>
                            <th>Assigned To</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="messages-list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Message Detail Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title" id="modalTitle">Message Details</h5>
                <div class="d-flex align-items-center gap-2">
                    <span id="modalStatus"></span>
                    <button type="button" class="btn btn-warning btn-sm" id="btnUncomplete" onclick="modalUncomplete()" style="display:none;">
                        <i class="bi bi-arrow-counterclockwise"></i> Uncomplete
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="btnComplete" onclick="modalComplete()">
                        <i class="bi bi-check-circle"></i> Complete
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>From:</strong> <span id="modalSender"></span></p>
                        <p class="mb-1"><strong>Phone:</strong> <span id="modalPhone"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Date:</strong> <span id="modalDate"></span></p>
                        <p class="mb-1"><strong>Source:</strong> <span id="modalSource"></span></p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label mb-1">Assigned To</label>
                        <div class="d-flex gap-2">
                            <select id="modalAssignUser" class="form-select form-select-sm">
                                <option value="">Unassigned</option>
                            </select>
                            <button class="btn btn-outline-dark btn-sm" onclick="modalAssignToMe()">
                                <i class="bi bi-person-plus"></i> Me
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label mb-1">Customer</label>
                        <input type="text" id="modalCustomer" class="form-control form-control-sm" placeholder="Customer...">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label mb-1">Notes</label>
                        <input type="text" id="modalNotes" class="form-control form-control-sm" placeholder="Notes...">
                    </div>
                </div>
                
                <!-- Audio player for voicemails -->
                <div id="audioSection" style="display: none;" class="mb-3">
                    <label class="form-label mb-1">Audio</label>
                    <audio id="modalAudio" controls class="w-100"></audio>
                </div>
                
                <div>
                    <label class="form-label mb-1">Content</label>
                    <pre id="modalBody" class="bg-light p-3 rounded mb-0" style="white-space: pre-wrap; min-height: 150px; max-height: 400px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let users = [];
let activeMessages = [];
let completeMessages = [];
let completeLoaded = false;
let currentUserId = null;
let selectedFilter = 'unassigned';
let viewingComplete = false;

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function getStatusBadge(status) {
    const badges = {
        'Unassigned': '<span class="badge bg-secondary">Unassigned</span>',
        'InProgress': '<span class="badge bg-warning text-dark">In Progress</span>',
        'Complete': '<span class="badge bg-success">Complete</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

function getSourceBadge(source) {
    const badges = {
        'email': '<span class="badge bg-primary">Email</span>',
        'voicemail': '<span class="badge bg-info">Voicemail</span>',
        'sms': '<span class="badge bg-purple" style="background-color: #6f42c1;">SMS</span>'
    };
    return badges[source] || '<span class="badge bg-secondary">Unknown</span>';
}

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadMessages();
    updateLastRefreshTime();
});

function loadUsers() {
    fetch('/api/operations/get-companies/')
        .then(r => r.json())
        .then(data => {
            users = data.users || [];
            currentUserId = data.current_user_id || null;
            populateFilterList();
        })
        .catch(() => {
            users = [];
            populateFilterList();
        });
}

function loadMessages() {
    fetch('/api/order-requests/')
        .then(r => r.json())
        .then(data => {
            activeMessages = data.messages || [];
            updateKPIs();
            populateFilterList();
        });
}

function loadComplete() {
    viewingComplete = true;
    if (completeLoaded) {
        showMessagesView('Completed');
        renderMessages(completeMessages);
        return;
    }
    
    fetch('/api/order-requests/complete/')
        .then(r => r.json())
        .then(data => {
            completeMessages = data.messages || [];
            completeLoaded = true;
            updateKPIs();
            showMessagesView('Completed');
            renderMessages(completeMessages);
        });
}

function updateKPIs() {
    const unassigned = activeMessages.filter(m => m.status === 'Unassigned').length;
    const inprogress = activeMessages.filter(m => m.status === 'InProgress').length;
    
    document.getElementById('kpi-incomplete').textContent = unassigned + inprogress;
    document.getElementById('kpi-unassigned').textContent = unassigned;
    document.getElementById('kpi-complete').textContent = completeLoaded ? completeMessages.length : '...';
}

function populateFilterList() {
    const container = document.getElementById('filter-list');
    const unassignedCount = activeMessages.filter(m => m.status === 'Unassigned').length;
    
    // Count by assigned user
    const userCounts = {};
    activeMessages.forEach(m => {
        if (m.assigned_user_id && m.status === 'InProgress') {
            userCounts[m.assigned_user_id] = (userCounts[m.assigned_user_id] || 0) + 1;
        }
    });
    
    let html = `
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2 ${selectedFilter === 'unassigned' ? 'active' : ''}" onclick="selectFilter('unassigned'); return false;">
            <span><i class="bi bi-inbox me-2"></i>Unassigned</span>
            <span class="badge bg-danger rounded-pill">${unassignedCount}</span>
        </a>
    `;
    
    // Add users with assigned messages
    users.filter(u => userCounts[u.id] > 0).forEach(user => {
        const isMe = user.id === currentUserId;
        const displayName = isMe ? `${user.name} (Me)` : user.name;
        html += `
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2 ${selectedFilter === 'user-' + user.id ? 'active' : ''}" onclick="selectFilter('user-${user.id}'); return false;">
                <span><i class="bi bi-person me-2"></i>${displayName}</span>
                <span class="badge bg-warning text-dark rounded-pill">${userCounts[user.id]}</span>
            </a>
        `;
    });
    
    container.innerHTML = html || '<div class="text-center text-muted py-3">No messages</div>';
}

function selectFilter(filter) {
    selectedFilter = filter;
    viewingComplete = false;
    populateFilterList();
    
    let filtered = [];
    let headerText = 'Order Requests';
    
    if (filter === 'unassigned') {
        filtered = activeMessages.filter(m => m.status === 'Unassigned');
        headerText = 'Unassigned';
    } else if (filter === 'incomplete') {
        filtered = activeMessages;
        headerText = 'All Incomplete';
    } else if (filter.startsWith('user-')) {
        const userId = parseInt(filter.replace('user-', ''));
        filtered = activeMessages.filter(m => m.assigned_user_id === userId);
        const user = users.find(u => u.id === userId);
        headerText = user ? user.name + "'s Messages" : 'Assigned';
    }
    
    showMessagesView(headerText);
    renderMessages(filtered);
}

function showMessagesView(headerText) {
    document.getElementById('filter-view').style.display = 'none';
    document.getElementById('messages-view').style.display = 'block';
    document.getElementById('messages-header').textContent = headerText;
}

function goBack() {
    document.getElementById('messages-view').style.display = 'none';
    document.getElementById('filter-view').style.display = 'block';
    viewingComplete = false;
    selectedFilter = 'unassigned';
    populateFilterList();
}

function renderMessages(messages) {
    const tbody = document.getElementById('messages-list');
    
    if (!messages.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No messages found</td></tr>';
        return;
    }
    
    tbody.innerHTML = messages.map(m => {
        const assignedUser = users.find(u => u.id === m.assigned_user_id);
        const assignedName = assignedUser ? assignedUser.name : '';
        const senderDisplay = m.sender_name || m.sender || '';
        
        return `
            <tr style="cursor: pointer;" onclick="openModal(${m.id})">
                <td>${m.date}</td>
                <td>${m.time}</td>
                <td>${getSourceBadge(m.source)}</td>
                <td title="${m.sender}">${senderDisplay.substring(0, 25)}${senderDisplay.length > 25 ? '...' : ''}</td>
                <td title="${m.subject}">${(m.subject || '').substring(0, 30)}${(m.subject || '').length > 30 ? '...' : ''}</td>
                <td>${m.customer || ''}</td>
                <td>${assignedName}</td>
                <td>${getStatusBadge(m.status)}</td>
            </tr>
        `;
    }).join('');
}

function updateLastRefreshTime() {
    const now = new Date();
    document.getElementById('lastRefresh').textContent = `Last updated: ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
}

function checkEmails(event) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Checking...';
    
    fetch('/api/check-order-emails/', { 
        method: 'POST', 
        headers: { 'X-CSRFToken': getCookie('csrftoken') } 
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(data.message || `Saved ${data.messages_saved} new messages`);
            loadMessages();
            updateLastRefreshTime();
        }
    })
    .catch(err => alert('Error: ' + err.message))
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });
}

// Modal functions
let currentModalId = null;

function openModal(id) {
    const allMessages = [...activeMessages, ...completeMessages];
    const m = allMessages.find(x => x.id === id);
    if (!m) return;
    
    currentModalId = id;
    const isComplete = m.status === 'Complete';
    
    document.getElementById('modalTitle').textContent = m.subject || 'No Subject';
    document.getElementById('modalSender').textContent = m.sender_name ? `${m.sender_name} <${m.sender}>` : m.sender;
    document.getElementById('modalPhone').textContent = m.sender_phone || 'N/A';
    document.getElementById('modalDate').textContent = `${m.date} ${m.time}`;
    document.getElementById('modalSource').innerHTML = getSourceBadge(m.source);
    document.getElementById('modalCustomer').value = m.customer || '';
    document.getElementById('modalNotes').value = m.notes || '';
    
    // Show body or transcription
    const content = m.transcription || m.body || 'No content';
    document.getElementById('modalBody').textContent = content;
    
    // Audio section for voicemails
    const audioSection = document.getElementById('audioSection');
    if (m.source === 'voicemail' && m.filename) {
        audioSection.style.display = 'block';
        document.getElementById('modalAudio').src = `/api/order-request/${id}/view/`;
    } else {
        audioSection.style.display = 'none';
    }
    
    // Status badge
    document.getElementById('modalStatus').innerHTML = getStatusBadge(m.status);
    
    // Populate user dropdown
    const select = document.getElementById('modalAssignUser');
    select.innerHTML = '<option value="">Unassigned</option>' + 
        users.map(u => `<option value="${u.id}" ${m.assigned_user_id === u.id ? 'selected' : ''}>${u.name}</option>`).join('');
    
    // Show/hide buttons based on status
    document.getElementById('btnComplete').style.display = isComplete ? 'none' : '';
    document.getElementById('btnUncomplete').style.display = isComplete ? '' : 'none';
    
    // Disable inputs if complete
    document.getElementById('modalAssignUser').disabled = isComplete;
    document.getElementById('modalCustomer').disabled = isComplete;
    document.getElementById('modalNotes').disabled = isComplete;
    
    new bootstrap.Modal(document.getElementById('messageModal')).show();
}

document.getElementById('modalAssignUser').addEventListener('change', function() {
    if (!currentModalId) return;
    fetch(`/api/order-request/${currentModalId}/assign-user/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ user_id: this.value || null })
    }).then(() => {
        loadMessages();
    });
});

document.getElementById('modalCustomer').addEventListener('blur', function() {
    if (!currentModalId) return;
    fetch(`/api/order-request/${currentModalId}/update-customer/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ customer: this.value })
    });
});

document.getElementById('modalNotes').addEventListener('blur', function() {
    if (!currentModalId) return;
    fetch(`/api/order-request/${currentModalId}/update-notes/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ notes: this.value })
    });
});

function modalAssignToMe() {
    if (!currentUserId) {
        alert('Could not determine current user');
        return;
    }
    document.getElementById('modalAssignUser').value = currentUserId;
    document.getElementById('modalAssignUser').dispatchEvent(new Event('change'));
}

function modalComplete() {
    if (!currentModalId) return;
    
    const m = activeMessages.find(x => x.id === currentModalId);
    if (m && !m.assigned_user_id) {
        alert('Please assign the message first');
        return;
    }
    
    fetch(`/api/order-request/${currentModalId}/complete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    }).then(() => {
        bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
        loadMessages();
        completeLoaded = false; // Force reload of complete list
    });
}

function modalUncomplete() {
    if (!currentModalId) return;
    
    fetch(`/api/order-request/${currentModalId}/uncomplete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    }).then(() => {
        bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
        loadMessages();
        completeLoaded = false;
    });
}
</script>
{% endblock %}