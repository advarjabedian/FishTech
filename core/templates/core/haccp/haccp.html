{% extends 'core/base.html' %}

{% block title %}HACCP - FishTech{% endblock %}

{% block extra_css %}
<style>
    .company-card {
        transition: transform 0.2s;
    }
    .company-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .master-plan-card {
        transition: all 0.2s;
        cursor: pointer;
        border: 2px solid #dee2e6;
    }
    .master-plan-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        border-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4"><i class="bi bi-shield-check me-2"></i>HACCP Documentation</h1>
    
    <div class="alert alert-info mb-4" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Note:</strong> For each product type and year, all companies share the same set of HACCP documents. 
        When you view or print a document through a specific company, only the company logo will differ.
    </div>
    
    <!-- Master Set Section -->
    <div class="card border-danger mb-4">
        <div class="card-header bg-danger text-white" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#masterPlansCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="bi bi-chevron-right me-2 collapse-icon"></i>
                        <i class="bi bi-star-fill me-2"></i>Master HACCP Plans
                    </h4>
                    <small>Edit and manage the master documents for all companies</small>
                </div>
                <div class="text-end">
                    <h5 class="mb-0">Year: {% now "Y" %}</h5>
                </div>
            </div>
        </div>
        <div id="masterPlansCollapse" class="collapse">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="text-muted mb-0">Available HACCP Product Types:</p>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-success" onclick="addNewProductTypePrompt()">
                            <i class="bi bi-plus-circle me-1"></i>Add Product Type
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="openRecycleBin()">
                            <i class="bi bi-trash me-1"></i>Recycle Bin
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="openManageProductTypesModal()">
                            <i class="bi bi-gear me-1"></i>Manage Product Types
                        </button>
                    </div>
                </div>
                <div class="row" id="master-product-types">
                    <!-- Product types will be loaded via JS with large icons -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Company-Specific Views Section -->
    <div class="card border-secondary mb-4">
        <div class="card-header bg-secondary text-white" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#companyViewsCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0">
                    <i class="bi bi-chevron-right me-2 collapse-icon"></i>
                    Company-Specific Views
                </h3>
            </div>
        </div>
        <div id="companyViewsCollapse" class="collapse">
            <div class="card-body">
                <div class="row">
                    {% for company in companies %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card company-card border-warning">
                            <div class="card-header bg-warning text-white" style="min-height: 90px;">
                    <div class="d-flex justify-content-between align-items-start">
                        <h5 class="mb-0" style="max-width: 55%;">{{ company.companyname }}</h5>
                        <div class="d-flex flex-column align-items-end gap-1 company-header-actions" id="header-actions-{{ company.companyid }}"></div>
                    </div>
                </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Product Types:</p>
                                <div class="d-flex flex-wrap" id="product-types-{{ company.companyid }}">
                                    <!-- Product types will be loaded via JS -->
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-warning btn-sm w-100" onclick="toggleProductTypeManager({{ company.companyid }})">
                                        <i class="bi bi-gear me-1"></i>Manage Product Types
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Company management moved to Manage Users page -->

<!-- Product Type Manager Modal -->
<div class="modal fade" id="productTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Product Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productTypeModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Master Version History Modal -->
<div class="modal fade" id="masterVersionHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="masterVersionModalTitle">Version History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2" id="masterYearNavigation">
                        <!-- Year buttons -->
                    </div>
                    <button type="button" class="btn btn-success" id="masterNewVersionBtn" style="display:none;" onclick="createMasterNewVersion()">
                        <i class="bi bi-plus-circle me-2"></i>New Version
                    </button>
                </div>
                <div id="masterVersionTableContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Manage Master Product Types Modal -->
<div class="modal fade" id="manageProductTypesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Product Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Add New Product Type</h6>
                    <div class="input-group">
                        <input type="text" class="form-control" id="newProductTypeNameModal" placeholder="Enter product type name">
                        <button class="btn btn-success" onclick="addNewProductTypeFromModal()">
                            <i class="bi bi-plus-circle me-1"></i>Add
                        </button>
                    </div>
                </div>
                <hr>
                <h6>Existing Product Types</h6>
                <div id="productTypesList">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recycle Bin Modal -->
<div class="modal fade" id="recycleBinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-trash me-2"></i>Recycle Bin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="recycleBinList">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Modal -->
<div class="modal fade" id="printModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="printModalTitle"><i class="bi bi-printer me-2"></i>Print Documents</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="printModalBody"></div>
        </div>
    </div>
</div>

<script>
let productTypes = [];
let productTypeModal;
let masterVersionHistoryModal;
let manageProductTypesModal;
let recycleBinModal;
let printModal;
let companyCompletedTypes = {};
let currentMasterProductType = '';
let currentMasterProductName = '';
let masterSelectedYear = {% now "Y" %};
let masterAllYears = [];

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function loadAllProductTypes() {
    return fetch('/api/haccp-all-product-types/')
        .then(r => r.json())
        .then(data => {
            productTypes = data.product_types;
            return data;
        })
        .catch(err => {
            console.error('Error loading product types:', err);
            productTypes = [];
            return { product_types: [] };
        });
}

// Company management moved to Manage Users page

// Existing HACCP Functions
document.addEventListener('DOMContentLoaded', function() {
    productTypeModal = new bootstrap.Modal(document.getElementById('productTypeModal'));
    masterVersionHistoryModal = new bootstrap.Modal(document.getElementById('masterVersionHistoryModal'));
    manageProductTypesModal = new bootstrap.Modal(document.getElementById('manageProductTypesModal'));
    recycleBinModal = new bootstrap.Modal(document.getElementById('recycleBinModal'));
    printModal = new bootstrap.Modal(document.getElementById('printModal'));
    
    loadAllProductTypes().then(() => {
        loadMasterProductTypes();
        loadAllCompanyProductTypes();
    });
    
    // Auto-expand company section if URL has expand parameter
    if (window.location.hash === '#companies') {
        new bootstrap.Collapse(document.getElementById('companyViewsCollapse'), {show: true});
    }
});


function loadMasterProductTypes() {
    fetch('/api/haccp-master-product-types/')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('master-product-types');
            container.innerHTML = '';
            
            if (data.active_types.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No product types available. Click "Manage Product Types" to add some.</div></div>';
                return;
            }
            
            data.active_types.forEach(slug => {
                const pt = productTypes.find(p => p.slug === slug);
                if (pt) {
                    const typeInfo = data.type_status[slug] || {status: 'not_started', completed_count: 0};
                    const status = typeInfo.status;
                    const completedCount = typeInfo.completed_count;
                    let statusBadge, iconColor, statusIcon;
                    
                    if (status === 'completed') {
                        statusBadge = '<span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i>Completed</span>';
                        iconColor = '#198754';
                        statusIcon = 'bi-folder-check';
                    } else if (status === 'in_progress') {
                        statusBadge = `<span class="badge bg-danger"><i class="bi bi-hourglass-split me-1"></i>${completedCount}/4 In Progress</span>`;
                        iconColor = '#dc3545';
                        statusIcon = 'bi-folder2-open';
                    } else {
                        statusBadge = '<span class="badge bg-secondary"><i class="bi bi-circle me-1"></i>Not Started</span>';
                        iconColor = '#6c757d';
                        statusIcon = 'bi-folder';
                    }
                    
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-lg-3 mb-3';
                    col.innerHTML = `
                        <div class="card master-plan-card" onclick="showMasterVersionHistory('${slug}', '${pt.name}')">
                            <div class="card-body text-center">
                                <i class="bi ${statusIcon} mb-2" style="font-size: 2.5rem; color: ${iconColor};"></i>
                                <h6 class="card-title mb-2">${pt.name}</h6>
                                <div class="mb-2">${statusBadge}</div>
                                <small class="text-muted">4 Documents</small>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                }
            });
        })
        .catch(err => console.error('Error loading master product types:', err));
}

function loadAllCompanyProductTypes() {
    {% for company in companies %}
    loadProductTypes({{ company.companyid }});
    {% endfor %}
}

function loadProductTypes(companyId) {
    fetch(`/api/company-product-types/${companyId}/`)
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById(`product-types-${companyId}`);
            container.innerHTML = '';
            
            let renderedCount = 0;
            let allComplete = true;
            
            if (data.active_types.length === 0) {
                container.innerHTML = '<span class="text-muted">No product types assigned</span>';
                allComplete = false;
            } else {
                data.active_types.forEach(slug => {
                    renderedCount++;
                    const isCompleted = data.completed_types.includes(slug);
                    
                    if (!isCompleted) {
                        allComplete = false;
                    }
                    
                    const pt = productTypes.find(p => p.slug === slug);
                    const name = pt ? pt.name : slug;
                    const badge = document.createElement('span');
                    badge.className = 'badge product-type-badge ' + (isCompleted ? 'bg-success' : 'bg-secondary');
                    badge.style.cssText = 'cursor: pointer; font-size: 0.95rem; padding: 8px 14px; margin-bottom: 6px;';
                    badge.innerHTML = isCompleted 
                        ? `<i class="bi bi-check-circle-fill me-1"></i>${pt.name}`
                        : pt.name;
                    badge.onclick = () => window.location.href = `/haccp/${companyId}/${slug}/`;
                    container.appendChild(badge);
                });
            }
            
            // Store completed types for print modal
            companyCompletedTypes[companyId] = data.completed_types || [];
            
            // Update compliance status
            const actionsContainer = document.getElementById(`header-actions-${companyId}`);
            actionsContainer.innerHTML = '';
            
            if (allComplete && renderedCount > 0) {
                const complianceBadge = document.createElement('span');
                complianceBadge.className = 'badge bg-success compliance-badge';
                complianceBadge.style.cssText = 'font-size: 0.95rem; padding: 8px 14px;';
                complianceBadge.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>In Compliance';
                actionsContainer.appendChild(complianceBadge);
            }
            
            // Show Print button if there are completed types
            if (companyCompletedTypes[companyId].length > 0) {
                const printBtn = document.createElement('button');
                printBtn.className = 'btn btn-sm btn-light print-btn';
                printBtn.innerHTML = '<i class="bi bi-printer me-1"></i>Print';
                printBtn.onclick = (e) => { e.stopPropagation(); openPrintModal(companyId); };
                actionsContainer.appendChild(printBtn);
            }
        })
        .catch(err => console.error('Error loading product types:', err));
}

function loadCertificateIcons(companyId, companyHeader) {
    fetch(`/api/company-certificates/${companyId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                let certIcons = companyHeader.querySelector('.cert-icons');
                if (!certIcons) {
                    certIcons = document.createElement('span');
                    certIcons.className = 'cert-icons ms-2';
                    companyHeader.appendChild(certIcons);
                }
                
                certIcons.innerHTML = '';
                
                const haccpCert = data.certificates.haccp_certificate;
                const logCert = data.certificates.letter_of_guarantee;
                
                const haccpIcon = document.createElement('i');
                haccpIcon.className = 'bi bi-file-earmark-text-fill ms-1';
                haccpIcon.style.fontSize = '1.2rem';
                haccpIcon.style.cursor = 'pointer';
                haccpIcon.style.color = haccpCert.is_completed ? '#198754' : '#6c757d';
                haccpIcon.title = 'HACCP Certificate';
                haccpIcon.onclick = () => window.location.href = `/haccp/certificate/${companyId}/haccp_certificate/`;
                certIcons.appendChild(haccpIcon);
                
                const logIcon = document.createElement('i');
                logIcon.className = 'bi bi-file-earmark-check-fill ms-1';
                logIcon.style.fontSize = '1.2rem';
                logIcon.style.cursor = 'pointer';
                logIcon.style.color = logCert.is_completed ? '#198754' : '#6c757d';
                logIcon.title = 'Letter of Guarantee';
                logIcon.onclick = () => window.location.href = `/haccp/certificate/${companyId}/letter_of_guarantee/`;
                certIcons.appendChild(logIcon);
            }
        })
        .catch(err => console.error('Error loading certificates:', err));
}

function openPrintModal(companyId) {
    const companyCard = document.getElementById(`product-types-${companyId}`).closest('.card');
    const companyName = companyCard.querySelector('.card-header h5').childNodes[0].textContent.trim();
    document.getElementById('printModalTitle').innerHTML = `<i class="bi bi-printer me-2"></i>Print - ${companyName}`;
    
    let html = '<h6 class="mb-2">Certificates</h6>';
    html += '<div class="d-flex flex-wrap gap-2 mb-4">';
    html += `<a href="/haccp/certificate/${companyId}/haccp_certificate/" class="btn btn-success"><i class="bi bi-file-earmark-text me-1"></i>HACCP Certificate</a>`;
    html += `<a href="/haccp/certificate/${companyId}/letter_of_guarantee/" class="btn btn-success"><i class="bi bi-file-earmark-check me-1"></i>Letter of Guarantee</a>`;
    html += '</div>';
    
    const completedSlugs = companyCompletedTypes[companyId] || [];
    if (completedSlugs.length > 0) {
        html += '<h6 class="mb-2">Print Full HACCP Plans</h6>';
        html += '<div class="d-flex flex-wrap gap-2">';
        completedSlugs.forEach(slug => {
            const pt = productTypes.find(p => p.slug === slug);
            if (pt) {
                html += `<a href="/haccp/${companyId}/${slug}/print/" class="btn btn-info text-white"><i class="bi bi-printer me-1"></i>${pt.name}</a>`;
            }
        });
        html += '</div>';
    }
    
    document.getElementById('printModalBody').innerHTML = html;
    printModal.show();
}

function toggleProductTypeManager(companyId) {
    fetch('/api/haccp-all-product-types/')
        .then(r => r.json())
        .then(data => {
            productTypes = data.product_types;
            return fetch(`/api/company-product-types/${companyId}/`);
        })
        .then(r => r.json())
        .then(data => {
            const activeTypes = data.active_types;
            const productTypeMap = {
                'box-in-box-out': 'Box In - Box Out',
                'live-molluscan': 'Live Molluscan',
                'non-scombroid': 'Non-Scombroid',
                'scombroid-haccp': 'Scombroid HACCP',
                'smoked-fish': 'Smoked Fish'
            };
            
            let html = '<div class="list-group">';
            productTypes.forEach(pt => {
                const isActive = activeTypes.includes(pt.slug);
                const displayName = productTypeMap[pt.slug] || pt.name;
                html += `
                    <div class="list-group-item">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="pt-${companyId}-${pt.slug}" 
                                ${isActive ? 'checked' : ''} 
                                onchange="toggleProductType(${companyId}, '${pt.slug}', this.checked)">
                            <label class="form-check-label" for="pt-${companyId}-${pt.slug}">
                                ${displayName}
                            </label>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('productTypeModalBody').innerHTML = html;
            productTypeModal.show();
        })
        .catch(err => {
            console.error('Error loading product types:', err);
            alert('Error loading product types');
        });
}

function toggleProductType(companyId, productType, isActive) {
    fetch(`/api/company-product-types/${companyId}/toggle/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            product_type: productType,
            is_active: isActive
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadProductTypes(companyId);
        } else {
            alert('Error updating product type');
            document.getElementById(`pt-${companyId}-${productType}`).checked = !isActive;
        }
    })
    .catch(err => {
        console.error('Error toggling product type:', err);
        alert('Error updating product type');
        document.getElementById(`pt-${companyId}-${productType}`).checked = !isActive;
    });
}

function showMasterVersionHistory(productTypeSlug, productTypeName) {
    currentMasterProductType = productTypeSlug;
    currentMasterProductName = productTypeName;
    masterSelectedYear = {% now "Y" %};
    
    document.getElementById('masterVersionModalTitle').textContent = `Version History - ${productTypeName}`;
    
    fetch(`/api/haccp-version-history/0/${productTypeSlug}/product_description/`)
        .then(r => r.json())
        .then(data => {
            masterAllYears = data.years;
            renderMasterYearNavigation();
            loadMasterVersionsForYear(masterSelectedYear);
            masterVersionHistoryModal.show();
        })
        .catch(err => {
            console.error('Error loading version history:', err);
            alert('Error loading version history');
        });
}

function renderMasterYearNavigation() {
    const nav = document.getElementById('masterYearNavigation');
    nav.innerHTML = '<strong style="margin-right: 15px; align-self: center;">Years:</strong>';
    
    if (masterAllYears.length === 0) {
        nav.innerHTML += '<span class="text-muted">No versions found</span>';
        return;
    }
    
    masterAllYears.forEach(year => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-primary year-btn';
        if (year === masterSelectedYear) {
            btn.classList.add('active');
        }
        btn.textContent = year;
        btn.onclick = () => {
            masterSelectedYear = year;
            renderMasterYearNavigation();
            loadMasterVersionsForYear(year);
        };
        nav.appendChild(btn);
    });
}

function loadMasterVersionsForYear(year) {
    const contentDiv = document.getElementById('masterVersionTableContent');
    contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
    
    fetch(`/api/haccp-version-history/0/${currentMasterProductType}/product_description/?year=${year}`)
        .then(r => r.json())
        .then(data => {
            renderMasterVersionTable(data.versions);
        })
        .catch(err => {
            console.error('Error loading versions:', err);
            contentDiv.innerHTML = '<div class="alert alert-danger">Error loading versions</div>';
        });
}

function renderMasterVersionTable(versions) {
    const contentDiv = document.getElementById('masterVersionTableContent');
    const newVersionBtn = document.getElementById('masterNewVersionBtn');
    
    if (versions.length === 0) {
        contentDiv.innerHTML = '<div class="alert alert-info">No versions found for this year. Click "New Version" to create the first version.</div>';
        newVersionBtn.style.display = 'block';
        return;
    }
    
    const completedSets = versions.filter(v => v.status === 'completed' && v.total_docs === 4 && v.completed_docs === 4);
    const activeSet = completedSets.length > 0 ? completedSets[0] : null;
    const inProgressSet = versions.find(v => v.status === 'in_progress' || v.completed_docs < 4);
    
    newVersionBtn.style.display = (!inProgressSet && (activeSet || versions.length === 0)) ? 'block' : 'none';
    
    let html = `
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Year</th>
                    <th>Version</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    versions.forEach(v => {
        const isActiveSet = activeSet && v.year === activeSet.year && v.version === activeSet.version;
        const isInProgress = inProgressSet && v.year === inProgressSet.year && v.version === inProgressSet.version;
        
        let badgeColor = 'secondary';
        let versionLabel = v.version;
        let rowClass = '';
        
        if (v.status === 'completed' && v.total_docs === 4 && v.completed_docs === 4) {
            badgeColor = 'success';
            if (isActiveSet) {
                versionLabel += ' <span class="badge bg-success ms-2">Active Version</span>';
                rowClass = 'table-success fw-bold';
            } else {
                versionLabel += ' <span class="text-danger ms-2">Archive Version</span>';
            }
        } else if (isInProgress) {
            badgeColor = 'warning';
            rowClass = 'table-warning';
        }
        
        html += `
            <tr class="${rowClass}" onclick="viewMasterVersion(${v.year}, ${v.version})" style="cursor: pointer;">
                <td>${v.year}</td>
                <td>${versionLabel}</td>
                <td><span class="badge bg-${badgeColor}">${v.status_display}</span></td>
                <td>${new Date(v.updated_at).toLocaleDateString()}</td>
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
    contentDiv.innerHTML = html;
}

function viewMasterVersion(year, version) {
    window.location.href = `/haccp/0/${currentMasterProductType}/?year=${year}&version=${version}`;
}

function createMasterNewVersion() {
    if (!confirm('Create a new version of all 4 documents based on the last completed set?')) {
        return;
    }
    
    fetch(`/api/haccp-generate-version/0/${currentMasterProductType}/product_description/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'New version created successfully');
            masterVersionHistoryModal.hide();
            window.location.href = `/haccp/0/${currentMasterProductType}/`;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error creating new version');
    });
}

function openManageProductTypesModal() {
    loadAndRenderProductTypesList();
    manageProductTypesModal.show();
}

function loadAndRenderProductTypesList() {
    fetch('/api/haccp-all-product-types/')
        .then(r => r.json())
        .then(data => {
            // Update global array
            productTypes = data.product_types;
            
            const container = document.getElementById('productTypesList');
            container.innerHTML = '';
            
            if (data.product_types.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No product types found.</div>';
                return;
            }
            
            data.product_types.forEach(pt => {
                const div = document.createElement('div');
                div.className = 'border rounded p-2 mb-2';
                div.id = `pt-row-${pt.slug}`;
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center" id="pt-display-${pt.slug}">
                        <span>${pt.name}</span>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="startEditProductType('${pt.slug}', '${pt.name.replace(/'/g, "\\'")}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProductType('${pt.slug}', '${pt.name.replace(/'/g, "\\'")}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-none" id="pt-edit-${pt.slug}">
                        <div class="input-group">
                            <input type="text" class="form-control form-control-sm" id="pt-input-${pt.slug}" value="${pt.name}">
                            <button class="btn btn-sm btn-success" onclick="saveProductTypeName('${pt.slug}')">
                                <i class="bi bi-check"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelEditProductType('${pt.slug}', '${pt.name.replace(/'/g, "\\'")}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        })
        .catch(err => console.error('Error loading product types:', err));
}

function startEditProductType(slug, currentName) {
    document.getElementById(`pt-display-${slug}`).classList.add('d-none');
    document.getElementById(`pt-edit-${slug}`).classList.remove('d-none');
    const input = document.getElementById(`pt-input-${slug}`);
    input.value = currentName;
    input.focus();
    input.select();
}

function cancelEditProductType(slug, originalName) {
    document.getElementById(`pt-display-${slug}`).classList.remove('d-none');
    document.getElementById(`pt-edit-${slug}`).classList.add('d-none');
}

function addNewProductTypeFromModal() {
    const input = document.getElementById('newProductTypeNameModal');
    const name = input.value.trim();
    
    if (!name) {
        alert('Please enter a product type name');
        return;
    }
    
    fetch('/api/haccp-add-product-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ name: name })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadAndRenderProductTypesList();
            loadMasterProductTypes();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error adding product type:', err);
        alert('Error adding product type');
    });
}

function saveProductTypeName(slug) {
    const newName = document.getElementById(`pt-input-${slug}`).value.trim();
    
    if (!newName) {
        alert('Name cannot be empty');
        return;
    }
    
    fetch('/api/haccp-update-product-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ slug: slug, name: newName })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error updating product type:', err);
        alert('Error updating product type');
    });
}

function addNewProductTypePrompt() {
    const name = prompt('Enter new product type name:');
    if (!name || !name.trim()) {
        return;
    }
    
    fetch('/api/haccp-add-product-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ name: name.trim() })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error adding product type:', err);
        alert('Error adding product type');
    });
}

function deleteProductType(slug, name) {
    if (!confirm(`Delete product type "${name}"? It will be moved to the recycle bin.`)) {
        return;
    }
    
    fetch('/api/haccp-delete-product-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ slug: slug })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadAndRenderProductTypesList();
            loadMasterProductTypes();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error deleting product type:', err);
        alert('Error deleting product type');
    });
}

function openRecycleBin() {
    fetch('/api/haccp-inactive-product-types/')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('recycleBinList');
            container.innerHTML = '';
            
            if (data.product_types.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Recycle bin is empty.</div>';
            } else {
                data.product_types.forEach(pt => {
                    const div = document.createElement('div');
                    div.className = 'list-group-item d-flex justify-content-between align-items-center';
                    div.innerHTML = `
                        <span>${pt.name}</span>
                        <button class="btn btn-sm btn-success" onclick="restoreProductType('${pt.slug}', '${pt.name}')">
                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                        </button>
                    `;
                    container.appendChild(div);
                });
            }
            
            recycleBinModal.show();
        })
        .catch(err => {
            console.error('Error loading recycle bin:', err);
            alert('Error loading recycle bin');
        });
}

function restoreProductType(slug, name) {
    if (!confirm(`Restore product type "${name}"?`)) {
        return;
    }
    
    fetch('/api/haccp-restore-product-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ slug: slug })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            openRecycleBin();
            loadMasterProductTypes();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error restoring product type:', err);
        alert('Error restoring product type');
    });
}
</script>
{% endblock %}