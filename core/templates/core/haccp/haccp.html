{% extends 'core/base.html' %}

{% block title %}HACCP - FishTech{% endblock %}

{% block extra_css %}
<style>
    .company-card {
        transition: transform 0.2s;
    }
    .company-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .master-plan-card {
        transition: all 0.2s;
        cursor: pointer;
        border: 2px solid #dee2e6;
    }
    .master-plan-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        border-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4"><i class="bi bi-shield-check me-2"></i>HACCP Documentation</h1>
    
    <div class="alert alert-info mb-4" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Note:</strong> For each product type and year, all companies share the same set of HACCP documents. 
        When you view or print a document through a specific company, only the company logo will differ.
    </div>
    
    <!-- Master Set Section -->
    <div class="card border-danger mb-4">
        <div class="card-header bg-danger text-white" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#masterPlansCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="bi bi-chevron-right me-2 collapse-icon"></i>
                        <i class="bi bi-star-fill me-2"></i>Master HACCP Plans
                    </h4>
                    <small>Edit and manage the master documents for all companies</small>
                </div>
                <div class="text-end">
                    <h5 class="mb-0">Year: {% now "Y" %}</h5>
                </div>
            </div>
        </div>
        <div id="masterPlansCollapse" class="collapse">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="text-muted mb-0">Available HACCP Product Types:</p>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="openRecycleBin()">
                            <i class="bi bi-trash me-1"></i>Recycle Bin
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="openManageProductTypesModal()">
                            <i class="bi bi-gear me-1"></i>Manage Product Types
                        </button>
                    </div>
                </div>
                <div class="row" id="master-product-types">
                    <!-- Product types will be loaded via JS with large icons -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Company-Specific Views Section -->
    <div class="card border-secondary mb-4">
        <div class="card-header bg-secondary text-white" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#companyViewsCollapse">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0">
                    <i class="bi bi-chevron-right me-2 collapse-icon"></i>
                    Company-Specific Views
                </h3>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addCompanyModal" onclick="event.stopPropagation()">
                    <i class="bi bi-plus-circle"></i> Add Company
                </button>
            </div>
        </div>
        <div id="companyViewsCollapse" class="collapse">
            <div class="card-body">
                <div class="row">
                    {% for company in companies %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card company-card border-warning">
                            <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">{{ company.companyname }}</h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-sm btn-outline-light" onclick="editCompany({{ company.companyid }}, '{{ company.companyname|escapejs }}', '{{ company.address|escapejs }}', '{{ company.city|escapejs }}', '{{ company.state|escapejs }}', '{{ company.zipcode|escapejs }}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-light" onclick="deleteCompany({{ company.companyid }}, '{{ company.companyname|escapejs }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Product Types:</p>
                                <div class="d-flex flex-wrap" id="product-types-{{ company.companyid }}">
                                    <!-- Product types will be loaded via JS -->
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-warning btn-sm w-100" onclick="toggleProductTypeManager({{ company.companyid }})">
                                        <i class="bi bi-gear me-1"></i>Manage Product Types
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Company Modal -->
<div class="modal fade" id="addCompanyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCompanyForm">
                    <div class="mb-3">
                        <label class="form-label">Company Name *</label>
                        <input type="text" class="form-control" id="add_companyname" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-control" id="add_address">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" id="add_city">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">State</label>
                            <input type="text" class="form-control" id="add_state" maxlength="2">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Zip Code</label>
                            <input type="text" class="form-control" id="add_zipcode">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddCompany()">Add Company</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Company Modal -->
<div class="modal fade" id="editCompanyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCompanyForm">
                    <input type="hidden" id="edit_company_id">
                    <div class="mb-3">
                        <label class="form-label">Company Name *</label>
                        <input type="text" class="form-control" id="edit_companyname" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-control" id="edit_address">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" id="edit_city">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">State</label>
                            <input type="text" class="form-control" id="edit_state" maxlength="2">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Zip Code</label>
                            <input type="text" class="form-control" id="edit_zipcode">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditCompany()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Product Type Manager Modal -->
<div class="modal fade" id="productTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Product Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productTypeModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Master Version History Modal -->
<div class="modal fade" id="masterVersionHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="masterVersionModalTitle">Version History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2" id="masterYearNavigation">
                        <!-- Year buttons -->
                    </div>
                    <button type="button" class="btn btn-success" id="masterNewVersionBtn" style="display:none;" onclick="createMasterNewVersion()">
                        <i class="bi bi-plus-circle me-2"></i>New Version
                    </button>
                </div>
                <div id="masterVersionTableContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Manage Master Product Types Modal -->
<div class="modal fade" id="manageProductTypesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Product Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Add New Product Type</h6>
                    <div class="input-group">
                        <input type="text" class="form-control" id="newProductTypeName" placeholder="Enter product type name">
                        <button class="btn btn-success" onclick="addNewProductType()">
                            <i class="bi bi-plus-circle me-1"></i>Add
                        </button>
                    </div>
                </div>
                <hr>
                <h6>Existing Product Types</h6>
                <div id="productTypesList">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recycle Bin Modal -->
<div class="modal fade" id="recycleBinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-trash me-2"></i>Recycle Bin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="recycleBinList">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let productTypes = [];
let productTypeModal;
let masterVersionHistoryModal;
let manageProductTypesModal;
let recycleBinModal;
let currentMasterProductType = '';
let currentMasterProductName = '';
let masterSelectedYear = {% now "Y" %};
let masterAllYears = [];

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function loadAllProductTypes() {
    return fetch('/api/haccp-all-product-types/')
        .then(r => r.json())
        .then(data => {
            productTypes = data.product_types;
            return data;
        })
        .catch(err => {
            console.error('Error loading product types:', err);
            productTypes = [];
            return { product_types: [] };
        });
}

// Company Management Functions
function submitAddCompany() {
    const data = {
        companyname: document.getElementById('add_companyname').value,
        address: document.getElementById('add_address').value,
        city: document.getElementById('add_city').value,
        state: document.getElementById('add_state').value,
        zipcode: document.getElementById('add_zipcode').value
    };
    
    fetch('{% url "add_company" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            window.location.href = window.location.pathname + '#companies';
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    });
}

function editCompany(id, name, address, city, state, zipcode) {
    document.getElementById('edit_company_id').value = id;
    document.getElementById('edit_companyname').value = name;
    document.getElementById('edit_address').value = address || '';
    document.getElementById('edit_city').value = city || '';
    document.getElementById('edit_state').value = state || '';
    document.getElementById('edit_zipcode').value = zipcode || '';
    
    new bootstrap.Modal(document.getElementById('editCompanyModal')).show();
}

function submitEditCompany() {
    const companyId = document.getElementById('edit_company_id').value;
    const data = {
        companyname: document.getElementById('edit_companyname').value,
        address: document.getElementById('edit_address').value,
        city: document.getElementById('edit_city').value,
        state: document.getElementById('edit_state').value,
        zipcode: document.getElementById('edit_zipcode').value
    };
    
    fetch(`/api/edit-company/${companyId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    });
}

function deleteCompany(id, name) {
    if (confirm(`Are you sure you want to delete company "${name}"? This will delete all associated HACCP documents.`)) {
        fetch(`/api/delete-company/${id}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        });
    }
}

// Existing HACCP Functions
document.addEventListener('DOMContentLoaded', function() {
    productTypeModal = new bootstrap.Modal(document.getElementById('productTypeModal'));
    masterVersionHistoryModal = new bootstrap.Modal(document.getElementById('masterVersionHistoryModal'));
    manageProductTypesModal = new bootstrap.Modal(document.getElementById('manageProductTypesModal'));
    recycleBinModal = new bootstrap.Modal(document.getElementById('recycleBinModal'));
    
    loadAllProductTypes().then(() => {
        loadMasterProductTypes();
        loadAllCompanyProductTypes();
    });
    
    // Auto-expand company section if URL has expand parameter
    if (window.location.hash === '#companies') {
        new bootstrap.Collapse(document.getElementById('companyViewsCollapse'), {show: true});
    }
});


function loadMasterProductTypes() {
    fetch('/api/haccp-master-product-types/')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('master-product-types');
            container.innerHTML = '';
            
            if (data.active_types.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No product types available. Click "Manage Product Types" to add some.</div></div>';
                return;
            }
            
            data.active_types.forEach(slug => {
                const pt = productTypes.find(p => p.slug === slug);
                if (pt) {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-lg-3 mb-3';
                    col.innerHTML = `
                        <div class="card master-plan-card" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <i class="bi bi-folder2-open mb-2" style="font-size: 2.5rem; color: #dc3545;"></i>
                                <h6 class="card-title mb-2">${pt.name}</h6>
                                <div class="document-count" style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">4</div>
                                <small class="text-muted">Documents</small>
                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); window.location.href='/haccp/0/${slug}/'">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); showMasterVersionHistory('${slug}', '${pt.name}')">
                                        <i class="bi bi-clock-history me-1"></i>History
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                }
            });
        })
        .catch(err => console.error('Error loading master product types:', err));
}

function loadAllCompanyProductTypes() {
    {% for company in companies %}
    loadProductTypes({{ company.companyid }});
    {% endfor %}
}

function loadProductTypes(companyId) {
    fetch(`/api/company-product-types/${companyId}/`)
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById(`product-types-${companyId}`);
            container.innerHTML = '';
            
            const productTypeMap = {
                'box-in-box-out': 'Box In - Box Out',
                'live-molluscan': 'Live Molluscan',
                'non-scombroid': 'Non-Scombroid',
                'scombroid-haccp': 'Scombroid HACCP',
                'smoked-fish': 'Smoked Fish'
            };
            
            if (data.active_types.length === 0) {
                container.innerHTML = '<span class="text-muted">No product types assigned</span>';
                return;
            }
            
            data.active_types.forEach(slug => {
                const isCompleted = data.completed_types.includes(slug);
                const name = productTypeMap[slug] || slug;
                const badge = document.createElement('span');
                badge.className = `badge ${isCompleted ? 'bg-success' : 'bg-secondary'} me-2 mb-2`;
                badge.style.cursor = 'pointer';
                badge.textContent = name;
                badge.onclick = () => window.location.href = `/haccp/${companyId}/${slug}/`;
                container.appendChild(badge);
            });
        })
        .catch(err => console.error('Error loading product types:', err));
}

function toggleProductTypeManager(companyId) {
    fetch('/api/haccp-all-product-types/')
        .then(r => r.json())
        .then(data => {
            productTypes = data.product_types;
            return fetch(`/api/company-product-types/${companyId}/`);
        })
        .then(r => r.json())
        .then(data => {
            const activeTypes = data.active_types;
            const productTypeMap = {
                'box-in-box-out': 'Box In - Box Out',
                'live-molluscan': 'Live Molluscan',
                'non-scombroid': 'Non-Scombroid',
                'scombroid-haccp': 'Scombroid HACCP',
                'smoked-fish': 'Smoked Fish'
            };
            
            let html = '<div class="list-group">';
            productTypes.forEach(pt => {
                const isActive = activeTypes.includes(pt.slug);
                const displayName = productTypeMap[pt.slug] || pt.name;
                html += `
                    <div class="list-group-item">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="pt-${companyId}-${pt.slug}" 
                                ${isActive ? 'checked' : ''} 
                                onchange="toggleProductType(${companyId}, '${pt.slug}', this.checked)">
                            <label class="form-check-label" for="pt-${companyId}-${pt.slug}">
                                ${displayName}
                            </label>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('productTypeModalBody').innerHTML = html;
            productTypeModal.show();
        })
        .catch(err => {
            console.error('Error loading product types:', err);
            alert('Error loading product types');
        });
}

function toggleProductType(companyId, productType, isActive) {
    fetch(`/api/company-product-types/${companyId}/toggle/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            product_type: productType,
            is_active: isActive
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadProductTypes(companyId);
        } else {
            alert('Error updating product type');
            document.getElementById(`pt-${companyId}-${productType}`).checked = !isActive;
        }
    })
    .catch(err => {
        console.error('Error toggling product type:', err);
        alert('Error updating product type');
        document.getElementById(`pt-${companyId}-${productType}`).checked = !isActive;
    });
}

function showMasterVersionHistory(productTypeSlug, productTypeName) {
    currentMasterProductType = productTypeSlug;
    currentMasterProductName = productTypeName;
    masterSelectedYear = {% now "Y" %};
    
    document.getElementById('masterVersionModalTitle').textContent = `Version History - ${productTypeName}`;
    
    fetch(`/api/haccp-version-history/0/${productTypeSlug}/product_description/`)
        .then(r => r.json())
        .then(data => {
            masterAllYears = data.years;
            renderMasterYearNavigation();
            loadMasterVersionsForYear(masterSelectedYear);
            masterVersionHistoryModal.show();
        })
        .catch(err => {
            console.error('Error loading version history:', err);
            alert('Error loading version history');
        });
}

function renderMasterYearNavigation() {
    const nav = document.getElementById('masterYearNavigation');
    nav.innerHTML = '<strong style="margin-right: 15px; align-self: center;">Years:</strong>';
    
    if (masterAllYears.length === 0) {
        nav.innerHTML += '<span class="text-muted">No versions found</span>';
        return;
    }
    
    masterAllYears.forEach(year => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-primary year-btn';
        if (year === masterSelectedYear) {
            btn.classList.add('active');
        }
        btn.textContent = year;
        btn.onclick = () => {
            masterSelectedYear = year;
            renderMasterYearNavigation();
            loadMasterVersionsForYear(year);
        };
        nav.appendChild(btn);
    });
}

function loadMasterVersionsForYear(year) {
    const contentDiv = document.getElementById('masterVersionTableContent');
    contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
    
    fetch(`/api/haccp-version-history/0/${currentMasterProductType}/product_description/?year=${year}`)
        .then(r => r.json())
        .then(data => {
            renderMasterVersionTable(data.versions);
        })
        .catch(err => {
            console.error('Error loading versions:', err);
            contentDiv.innerHTML = '<div class="alert alert-danger">Error loading versions</div>';
        });
}

function renderMasterVersionTable(versions) {
    const contentDiv = document.getElementById('masterVersionTableContent');
    const newVersionBtn = document.getElementById('masterNewVersionBtn');
    
    if (versions.length === 0) {
        contentDiv.innerHTML = '<div class="alert alert-info">No versions found for this year. Click "New Version" to create the first version.</div>';
        newVersionBtn.style.display = 'block';
        return;
    }
    
    const completedSets = versions.filter(v => v.status === 'completed' && v.total_docs === 4 && v.completed_docs === 4);
    const activeSet = completedSets.length > 0 ? completedSets[0] : null;
    const inProgressSet = versions.find(v => v.status === 'in_progress' || v.completed_docs < 4);
    
    newVersionBtn.style.display = (!inProgressSet && (activeSet || versions.length === 0)) ? 'block' : 'none';
    
    let html = `
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Year</th>
                    <th>Version</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    versions.forEach(v => {
        const isActiveSet = activeSet && v.year === activeSet.year && v.version === activeSet.version;
        const isInProgress = inProgressSet && v.year === inProgressSet.year && v.version === inProgressSet.version;
        
        let badgeColor = 'secondary';
        let versionLabel = v.version;
        let rowClass = '';
        
        if (v.status === 'completed' && v.total_docs === 4 && v.completed_docs === 4) {
            badgeColor = 'success';
            if (isActiveSet) {
                versionLabel += ' <span class="badge bg-success ms-2">Active Version</span>';
                rowClass = 'table-success fw-bold';
            } else {
                versionLabel += ' <span class="text-danger ms-2">Archive Version</span>';
            }
        } else if (isInProgress) {
            badgeColor = 'warning';
            rowClass = 'table-warning';
        }
        
        html += `
            <tr class="${rowClass}" onclick="viewMasterVersion(${v.year}, ${v.version})" style="cursor: pointer;">
                <td>${v.year}</td>
                <td>${versionLabel}</td>
                <td><span class="badge bg-${badgeColor}">${v.status_display}</span></td>
                <td>${new Date(v.updated_at).toLocaleDateString()}</td>
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
    contentDiv.innerHTML = html;
}

function viewMasterVersion(year, version) {
    window.location.href = `/haccp/0/${currentMasterProductType}/?year=${year}&version=${version}`;
}

function createMasterNewVersion() {
    if (!confirm('Create a new version of all 4 documents based on the last completed set?')) {
        return;
    }
    
    fetch(`/api/haccp-generate-version/0/${currentMasterProductType}/product_description/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'New version created successfully');
            masterVersionHistoryModal.hide();
            window.location.href = `/haccp/0/${currentMasterProductType}/`;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error creating new version');
    });
}

function openManageProductTypesModal() {
    loadAndRenderProductTypesList();
    manageProductTypesModal.show();
}

function loadAndRenderProductTypesList() {
    fetch('/api/haccp-all-product-types/')
        .then(r => r.json())
        .then(data => {
            // Update global array
            productTypes = data.product_types;
            
            const container = document.getElementById('productTypesList');
            container.innerHTML = '';
            
            if (data.product_types.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No product types found.</div>';
                return;
            }
            
            const productTypeMap = {
                'box-in-box-out': 'Box In - Box Out',
                'live-molluscan': 'Live Molluscan',
                'non-scombroid': 'Non-Scombroid',
                'scombroid-haccp': 'Scombroid HACCP',
                'smoked-fish': 'Smoked Fish'
            };
            
            data.product_types.forEach(pt => {
                const displayName = productTypeMap[pt.slug] || pt.name;
                const div = document.createElement('div');
                div.className = 'list-group-item d-flex justify-content-between align-items-center';
                div.innerHTML = `
                    <span>${displayName}</span>
                    <button class="btn btn-sm btn-danger" onclick="deleteProductType('${pt.slug}', '${displayName}')">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        })
        .catch(err => console.error('Error loading product types:', err));
}

function addNewProductType() {
    const name = document.getElementById('newProductTypeName').value.trim();
    if (!name) {
        alert('Please enter a product type name');
        return;
    }
    
    fetch('/api/haccp-add-product-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ name: name })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('newProductTypeName').value = '';
            loadAndRenderProductTypesList();
            loadMasterProductTypes();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error adding product type:', err);
        alert('Error adding product type');
    });
}

function deleteProductType(slug, name) {
    if (!confirm(`Delete product type "${name}"? It will be moved to the recycle bin.`)) {
        return;
    }
    
    fetch('/api/haccp-delete-product-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ slug: slug })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadAndRenderProductTypesList();
            loadMasterProductTypes();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error deleting product type:', err);
        alert('Error deleting product type');
    });
}

function openRecycleBin() {
    fetch('/api/haccp-inactive-product-types/')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('recycleBinList');
            container.innerHTML = '';
            
            if (data.product_types.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Recycle bin is empty.</div>';
            } else {
                data.product_types.forEach(pt => {
                    const div = document.createElement('div');
                    div.className = 'list-group-item d-flex justify-content-between align-items-center';
                    div.innerHTML = `
                        <span>${pt.name}</span>
                        <button class="btn btn-sm btn-success" onclick="restoreProductType('${pt.slug}', '${pt.name}')">
                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                        </button>
                    `;
                    container.appendChild(div);
                });
            }
            
            recycleBinModal.show();
        })
        .catch(err => {
            console.error('Error loading recycle bin:', err);
            alert('Error loading recycle bin');
        });
}

function restoreProductType(slug, name) {
    if (!confirm(`Restore product type "${name}"?`)) {
        return;
    }
    
    fetch('/api/haccp-restore-product-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ slug: slug })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            openRecycleBin();
            loadMasterProductTypes();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error restoring product type:', err);
        alert('Error restoring product type');
    });
}
</script>
{% endblock %}