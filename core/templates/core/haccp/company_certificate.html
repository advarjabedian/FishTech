{% extends 'core/base.html' %}
{% load static %}

{% block extra_css %}
<style>
.certificate-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 40px;
    background: white;
    border: 1px solid #ddd;
    font-family: 'Times New Roman', serif;
}
.certificate-header {
    text-align: center;
    margin-bottom: 30px;
}
.certificate-body {
    text-align: justify;
    line-height: 1.8;
    margin-bottom: 30px;
}
.certificate-body p {
    margin-bottom: 20px;
}
.signature-section {
    margin-top: 40px;
}
@media print {
    .no-print {
        display: none !important;
    }
    .certificate-content {
        border: none;
        padding: 0;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h2>{{ company.companyname }} - {{ certificate_type_display }} {{ current_year }}</h2>
        <div>
            <button class="btn btn-info me-2" onclick="window.print()">
                <i class="bi bi-printer"></i> Print
            </button>
            <a href="{% url 'haccp' %}" class="btn btn-secondary">Back to HACCP</a>
        </div>
    </div>
    
    <div class="certificate-content">
        {% if certificate.certificate_type == 'haccp_certificate' %}
        <div class="certificate-header" style="position: relative;">
            {% if company.logo %}
            <img src="{{ company.logo }}" alt="{{ company.companyname }} Logo" style="position: absolute; left: 0; top: 0; max-width: 150px; height: auto;">
            {% endif %}
            
            <h3>{{ company.companyname }}</h3>
            {% if company.tradename %}
            <p>DBA: {{ company.tradename }}</p>
            {% endif %}
            <p>{{ company.address }}<br>{{ company.city }}, {{ company.state }} {{ company.zipcode }}</p>
            <p style="text-align: right; margin-top: 20px;">
                <span id="display_date">Date: {% if certificate.date_issued %}{{ certificate.date_issued|date:"F jS Y" }}{% else %}January 1st {{ current_year }}{% endif %}</span><br>
                12:00PM PST
            </p>
        </div>
        
        <h4 style="text-align: center; margin-bottom: 30px;">HACCP Certificate</h4>
        
        <div class="certificate-body">
            <p>Dear Valued Customer,</p>
            
            <p>In compliance with the U.S. Department of Health and Human Services, Food and Drug Administration, 21 CFR part 123 and 1240 certify that {{ company.companyname }}, has performed a Hazard Analysis of all species supplied [Sec. 123.6(b)(1)], has identified Critical Control Points to monitor to prevent or minimize the occurrence of the hazards of species.</p>
            
            <p>Further, we certify that we monitor these Critical Control Points to ensure both the monitoring is done as a matter of routine, and that it is done in appropriate manner with sufficient frequency to establish preventative control, and have developed, and maintained a record keeping system for this monitoring that establishes our effective implementation of our system of preventative controls, and record how these controls are operating over time.</p>
        </div>
        {% else %}
        <div class="certificate-header" style="position: relative;">
            {% if company.logo %}
            <img src="{{ company.logo }}" alt="{{ company.companyname }} Logo" style="position: absolute; left: 0; top: 0; max-width: 150px; height: auto;">
            {% endif %}
            
            <h3>{{ company.companyname }}</h3>
            {% if company.tradename %}
            <p>DBA: {{ company.tradename }}</p>
            {% endif %}
            <p>{{ company.address }}<br>{{ company.city }}, {{ company.state }} {{ company.zipcode }}</p>
            <p style="margin-top: 20px;">
                <span id="display_date">{% if certificate.date_issued %}{{ certificate.date_issued|date:"F jS, Y" }}{% else %}January 1st, {{ current_year }}{% endif %}</span><br>
                12:00PM PST
            </p>
        </div>
        
        <h4 style="text-align: center; margin-bottom: 30px;">Letter of Guarantee</h4>
        
        <div class="certificate-body">
            <p><strong>To Whom It May Concern,</strong></p>
            
            <p>This letter is to confirm that {{ company.companyname }} is operating under a HACCP Program. Prerequisites are in place and support the HACCP Plan.</p>
            
            <p>{{ company.companyname }} Safety Manual covers: Premises, Storage and Transportation, Equipment, Personnel, Sanitation, Recall, Allergen, Quality, and HACCP.</p>
            
            <p>Each Stage of our process is defined to eliminate or reduce food safety hazards and concerns. Our goal is to produce products to customer specifications and to provide the best and safest products to all our customers.</p>
            
            <p>If you have any questions or concerns, please do not hesitate to contact us.</p>
        </div>
        {% endif %}
        
        <div class="signature-section">
            <p style="margin-bottom: 5px;">
                {% if certificate.certificate_type == 'haccp_certificate' %}Thank you,{% else %}Sincerely,{% endif %}
            </p>
            <div style="margin: 20px 0;">
                <canvas id="signature_canvas" width="300" height="100" style="border: 2px solid #000; cursor: pointer;"></canvas>
            </div>
            <p style="margin-top: 5px;">
                <strong><span id="display_signed_by">{{ certificate.signed_by|default:"" }}</span></strong><br>
                {% if certificate.certificate_type == 'haccp_certificate' %}(HACCP Certified Personnel){% else %}(Supervisor){% endif %}
            </p>
        </div>
    </div>
    
    <div class="card mt-4 no-print">
        <div class="card-body">
            <h5 class="mb-3">Edit Certificate</h5>
            
            <div class="mb-3">
                <label class="form-label">Date Issued:</label>
                <input type="date" class="form-control" id="date_issued" value="{{ certificate.date_issued|date:'Y-m-d' }}" onchange="updateDisplayDate()">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Signed By:</label>
                <input type="text" class="form-control" id="signed_by" value="{{ certificate.signed_by|default:'' }}" placeholder="Enter name" onchange="updateDisplaySignedBy()">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Signature:</label>
                <button type="button" class="btn btn-sm btn-secondary" onclick="clearSignature()">Clear Signature</button>
            </div>
            
            <div class="mt-4">
                <button type="button" class="btn btn-primary" onclick="saveCertificate(false)">Save Draft</button>
                <button type="button" class="btn btn-success" onclick="saveCertificate(true)">Mark Complete</button>
            </div>
        </div>
    </div>
</div>

<script>
let canvas = document.getElementById('signature_canvas');
let ctx = canvas.getContext('2d');
let isDrawing = false;

{% if certificate.signature %}
const img = new Image();
img.onload = function() {
    ctx.drawImage(img, 0, 0);
};
img.src = '{{ certificate.signature }}';
{% endif %}

canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('mouseout', stopDrawing);

function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.stroke();
}

function stopDrawing() {
    isDrawing = false;
}

function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function updateDisplayDate() {
    const dateInput = document.getElementById('date_issued');
    const displayDate = document.getElementById('display_date');
    
    if (dateInput.value) {
        const date = new Date(dateInput.value + 'T00:00:00');
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('en-US', options);
        const dayNum = date.getDate();
        const suffix = dayNum === 1 || dayNum === 21 || dayNum === 31 ? 'st' : 
                       dayNum === 2 || dayNum === 22 ? 'nd' :
                       dayNum === 3 || dayNum === 23 ? 'rd' : 'th';
        
        {% if certificate.certificate_type == 'haccp_certificate' %}
        displayDate.textContent = `Date: ${formattedDate.replace(/\d+/, dayNum + suffix)}`;
        {% else %}
        displayDate.textContent = formattedDate.replace(/\d+/, dayNum + suffix);
        {% endif %}
    }
}

function updateDisplaySignedBy() {
    const signedByInput = document.getElementById('signed_by');
    const displaySignedBy = document.getElementById('display_signed_by');
    displaySignedBy.textContent = signedByInput.value;
}

function saveCertificate(markComplete) {
    const data = {
        certificate_type: '{{ certificate.certificate_type }}',
        date_issued: document.getElementById('date_issued').value,
        signed_by: document.getElementById('signed_by').value,
        signature: canvas.toDataURL(),
        is_completed: markComplete
    };
    
    fetch('/api/company-certificates/{{ company.companyid }}/save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert('Certificate saved successfully');
            window.location.href = '{% url "haccp" %}';
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error saving certificate');
    });
}
</script>
{% endblock %}