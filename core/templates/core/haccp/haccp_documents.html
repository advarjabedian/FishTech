{% extends 'core/base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/haccp.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if company.companyid != 0 and not has_completed_set %}
    <div class="alert alert-warning mb-4" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>No Completed HACCP Plan:</strong> There is no completed HACCP plan for {{ product_type }} in {{ current_year }}. 
        Documents must be completed in the <a href="/haccp/0/{{ product_type_slug }}/" class="alert-link">Master Set</a> before they appear here.
    </div>
    </div>
    {% else %}
    
    <div class="mb-3 d-flex justify-content-between align-items-center">
    <a href="{% url 'haccp' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to HACCP Home
    </a>
    {% if company.companyid == 0 %}
    <div>
        {% if not has_in_progress_set and active_version %}
        <button type="button" class="btn btn-success me-2" onclick="createNewVersion()">
            <i class="bi bi-plus-circle me-2"></i>New Version
        </button>
        {% endif %}
        <button type="button" class="btn btn-info text-white" onclick="showAllVersionHistory()">
            <i class="bi bi-clock-history me-2"></i>Version History
        </button>
    </div>
    {% endif %}
</div>
    
    <div class="d-flex align-items-center mb-4">
        <i class="bi bi-folder2-open me-3" style="font-size: 2.5rem; color: {% if company.companyid == 0 %}#dc3545{% else %}#fd7e14{% endif %};"></i>
        <div class="flex-grow-1">
            <h1 class="mb-0 text-uppercase">{{ product_type }}</h1>
            <p class="{% if company.companyid == 0 %}text-danger fw-bold{% else %}text-muted{% endif %} mb-0">{{ company.companyname }} - HACCP Documents</p>
            {% if current_version %}
            <div class="mt-2">
                <span class="badge bg-secondary" style="font-size: 0.9rem;">Version {{ current_version }}</span>
               {% if set_is_complete and current_version == active_version %}
            <span class="badge bg-success" style="font-size: 0.9rem;">Active Version</span>
            {% elif set_is_complete %}
            <span class="badge bg-warning text-dark" style="font-size: 0.9rem;">Archive Version</span>
            {% else %}
            <span class="badge bg-info" style="font-size: 0.9rem;">In Progress</span>
            {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="text-end">
            {% if set_is_complete %}
                <span class="badge {% if company.companyid == 0 %}bg-danger{% else %}bg-success{% endif %}" style="font-size: 1.2rem; padding: 0.75rem 1.5rem;">
                    <i class="bi bi-check-circle me-2"></i>Set Complete
                </span>
            {% else %}
                <span class="badge {% if company.companyid == 0 %}bg-danger{% else %}bg-warning text-dark{% endif %}" style="font-size: 1.2rem; padding: 0.75rem 1.5rem;">
                    <i class="bi bi-hourglass-split me-2"></i>{{ completed_count }}/{{ total_documents }} Complete
                </span>
            {% endif %}
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="card mb-4 {% if company.companyid == 0 %}border-danger{% else %}border-warning{% endif %}">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Document Set Progress - {{ current_year }}</h6>
                <strong>{{ completion_percentage }}%</strong>
            </div>
            <div class="progress" style="height: 25px;">
                <div class="progress-bar {% if company.companyid == 0 %}{% if set_is_complete %}bg-danger{% else %}bg-danger{% endif %}{% else %}{% if set_is_complete %}bg-success{% else %}bg-warning{% endif %}{% endif %}" 
                     role="progressbar" 
                     style="width: {{ completion_percentage }}%;" 
                     aria-valuenow="{{ completion_percentage }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                    {{ completed_count }} of {{ total_documents }} documents completed
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        {% for doc in documents %}
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card document-card {% if company.companyid == 0 %}border-danger{% else %}border-warning{% endif %} position-relative" onclick="window.location.href='{% url 'haccp_document_view' company.companyid product_type_slug doc.type %}'">
                {% if doc.status == 'not_started' %}
                    <span class="badge status-badge bg-secondary">Not Started</span>
                {% elif doc.status == 'in_progress' %}
                    <span class="badge status-badge bg-info">In Progress</span>
                {% elif doc.status == 'completed' %}
                    <span class="badge status-badge bg-success">Completed</span>
                {% elif doc.status == 'approved' %}
                    <span class="badge status-badge bg-primary">Approved</span>
                {% endif %}
                
                <div class="card-body text-center">
                    <i class="bi {{ doc.icon }} document-icon mb-3"></i>
                    <h5 class="card-title">{{ doc.name }}</h5>
                    <p class="text-muted small">Click to view/edit</p>
                </div>
                <div class="card-footer {% if company.companyid == 0 %}bg-danger{% else %}bg-warning{% endif %} bg-opacity-10">
                    <small class="text-muted">
                        <i class="bi bi-calendar3 me-1"></i>
                        {% if doc.approved_date and doc.approved_by %}
                            Reviewed and Approved by {{ doc.approved_by }} on {{ doc.approved_date|date:"m/d/Y" }}
                        {% else %}
                            Not signed
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Version History Modal -->
<div class="modal fade" id="allVersionHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Version History - {{ product_type }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Year Navigation -->
                <div class="mb-3 d-flex gap-2" id="yearNavigation">
                    <!-- Year buttons will be populated here -->
                </div>
                
                <!-- Single version table (no tabs needed since it's set-level) -->
                <div id="versionTableContent"></div>
            </div>
        </div>
    </div>
</div>

<style>
#allVersionHistoryModal .modal-body {
    color: #000;
}

#allVersionHistoryModal table {
    color: #000;
}

#allVersionHistoryModal .badge {
    color: #fff !important;
}

#yearNavigation .year-btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.version-table {
    width: 100%;
}

.version-table th {
    background-color: #f8f9fa;
    padding: 12px;
    text-align: left;
    border: 1px solid #dee2e6;
}

.version-table td {
    padding: 12px;
    border: 1px solid #dee2e6;
}

.version-table tr:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
let allVersionHistoryModal;
let selectedYear = {{ current_year }};
let allYears = [];

document.addEventListener('DOMContentLoaded', function() {
    allVersionHistoryModal = new bootstrap.Modal(document.getElementById('allVersionHistoryModal'));
});

function showAllVersionHistory() {
    selectedYear = {{ current_year }};
    
    // Load set-level version history
    fetch(`/api/haccp-version-history/{{ company.companyid }}/{{ product_type_slug }}/product_description/`)
        .then(r => r.json())
        .then(data => {
            allYears = data.years;
            renderYearNavigation();
            loadVersionsForYear(selectedYear);
            allVersionHistoryModal.show();
        })
        .catch(err => {
            console.error('Error loading version history:', err);
            alert('Error loading version history');
        });
}

function renderYearNavigation() {
    const nav = document.getElementById('yearNavigation');
    nav.innerHTML = '<strong style="margin-right: 15px; align-self: center;">Years:</strong>';
    
    if (allYears.length === 0) {
        nav.innerHTML += '<span class="text-muted">No versions found</span>';
        return;
    }
    
    allYears.forEach(year => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-primary year-btn';
        if (year === selectedYear) {
            btn.classList.add('active');
        }
        btn.textContent = year;
        btn.onclick = () => {
            selectedYear = year;
            renderYearNavigation();
            loadVersionsForYear(year);
        };
        nav.appendChild(btn);
    });
}

function loadVersionsForYear(year) {
    const contentDiv = document.getElementById('versionTableContent');
    contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
    
    fetch(`/api/haccp-version-history/{{ company.companyid }}/{{ product_type_slug }}/product_description/?year=${year}`)
        .then(r => r.json())
        .then(data => {
            renderVersionTable(data.versions);
        })
        .catch(err => {
            console.error('Error loading versions:', err);
            contentDiv.innerHTML = '<div class="alert alert-danger">Error loading versions</div>';
        });
}

function renderVersionTable(versions) {
    const contentDiv = document.getElementById('versionTableContent');
    
    if (versions.length === 0) {
        contentDiv.innerHTML = '<div class="alert alert-info">No versions found for this year</div>';
        return;
    }
    
    // Find the latest completed SET (4/4 completed)
    const completedSets = versions.filter(v => v.status === 'completed' && v.total_docs === 4 && v.completed_docs === 4);
    const activeSet = completedSets.length > 0 ? completedSets[0] : null;
    
    // Find the in-progress set (if any)
    const inProgressSet = versions.find(v => v.status === 'in_progress' || v.completed_docs < 4);
    
    let html = `
        <table class="version-table">
            <thead>
                <tr>
                    <th>Year</th>
                    <th>Version</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    versions.forEach(v => {
        const isActiveSet = activeSet && v.year === activeSet.year && v.version === activeSet.version;
        const isInProgress = inProgressSet && v.year === inProgressSet.year && v.version === inProgressSet.version;
        
        let badgeColor = 'secondary';
        let badgeText = v.status_display;
        let versionLabel = v.version;
        let rowClass = '';
        
        if (v.status === 'completed' && v.total_docs === 4 && v.completed_docs === 4) {
            badgeColor = 'success';
            if (isActiveSet) {
                versionLabel += ' <span class="badge bg-success ms-2">Active Version</span>';
                rowClass = 'table-success fw-bold';
            } else {
                versionLabel += ' <span class="text-danger ms-2">Archive Version</span>';
            }
        } else if (isInProgress) {
            badgeColor = 'warning';
            rowClass = 'table-warning';
        } else {
            badgeColor = 'secondary';
        }
        
        html += `
            <tr class="${rowClass}" onclick="viewVersion(${v.year}, ${v.version})" style="cursor: pointer;">
                <td>${v.year}</td>
                <td>${versionLabel}</td>
                <td><span class="badge bg-${badgeColor}">${badgeText}</span></td>
                <td>${new Date(v.updated_at).toLocaleDateString()}</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    contentDiv.innerHTML = html;
}

function viewVersion(year, version) {
    window.location.href = `/haccp/{{ company.companyid }}/{{ product_type_slug }}/?year=${year}&version=${version}`;
}

function createNewVersion() {
    if (!confirm('Create a new version of all 4 documents based on the last completed set?')) {
        return;
    }
    
    fetch('/api/haccp-generate-version/{{ company.companyid }}/{{ product_type_slug }}/product_description/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'New version created successfully');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error creating new version');
    });
}
</script>
{% endblock %}