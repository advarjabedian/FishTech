<script>
// ============================================
// UTILITY FUNCTIONS
// ============================================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ============================================
// CONFIG MANAGEMENT
// ============================================
function updateConfig(companyId, field, value) {
    fetch('/api/operations/update-config/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            company_id: companyId,
            field: field,
            value: value
        })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            alert('Error updating config');
        }
    });
}

// ============================================
// OPERATING DAYS MODAL
// ============================================
function showDaysModal(companyId, companyName, mon, tue, wed, thu, fri, sat, sun) {
    document.getElementById('modal-company-id').value = companyId;
    document.getElementById('modal-company-name').textContent = companyName;
    
    document.getElementById('modal-mon').checked = mon;
    document.getElementById('modal-tue').checked = tue;
    document.getElementById('modal-wed').checked = wed;
    document.getElementById('modal-thu').checked = thu;
    document.getElementById('modal-fri').checked = fri;
    document.getElementById('modal-sat').checked = sat;
    document.getElementById('modal-sun').checked = sun;
    
    new bootstrap.Modal(document.getElementById('daysModal')).show();
}

function saveDays() {
    const companyId = document.getElementById('modal-company-id').value;
    
    const days = {
        monday: document.getElementById('modal-mon').checked,
        tuesday: document.getElementById('modal-tue').checked,
        wednesday: document.getElementById('modal-wed').checked,
        thursday: document.getElementById('modal-thu').checked,
        friday: document.getElementById('modal-fri').checked,
        saturday: document.getElementById('modal-sat').checked,
        sunday: document.getElementById('modal-sun').checked
    };
    
    fetch('/api/operations/update-config/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            company_id: companyId,
            field: 'operating_days',
            value: days
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('daysModal')).hide();
            location.reload();
        } else {
            alert('Error saving days');
        }
    });
}

// ============================================
// SIGNATURE CAPTURE
// ============================================
var signatureCanvas, signatureCtx;
var isDrawing = false;
var currentSignatureCompanyId = null;
var currentSignatureType = null;

function initSignatureCanvas() {
    signatureCanvas = document.getElementById('signatureCanvas');
    if (!signatureCanvas) return;
    
    signatureCtx = signatureCanvas.getContext('2d');
    
    signatureCtx.fillStyle = 'white';
    signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    
    // Mouse events
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events
    signatureCanvas.addEventListener('touchstart', handleTouchStart);
    signatureCanvas.addEventListener('touchmove', handleTouchMove);
    signatureCanvas.addEventListener('touchend', stopDrawing);
}

function startDrawing(e) {
    isDrawing = true;
    signatureCtx.beginPath();
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    signatureCtx.strokeStyle = 'black';
    signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    signatureCtx.stroke();
    signatureCtx.beginPath();
    signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function stopDrawing() {
    isDrawing = false;
    signatureCtx.beginPath();
}

function handleTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = signatureCanvas.getBoundingClientRect();
    isDrawing = true;
    signatureCtx.beginPath();
    signatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const touch = e.touches[0];
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    signatureCtx.strokeStyle = 'black';
    signatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
    signatureCtx.stroke();
    signatureCtx.beginPath();
    signatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
}

function clearSignature() {
    if (!signatureCanvas) return;
    signatureCtx.fillStyle = 'white';
    signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
}

function openSignatureCapture(companyId, type) {
    currentSignatureCompanyId = companyId;
    currentSignatureType = type;
    
    const select = document.getElementById(`${type}-select-${companyId}`);
    const userName = select ? select.options[select.selectedIndex].text : 'User';
    
    document.getElementById('signatureUserName').textContent = userName;
    document.getElementById('signatureModalTitle').textContent = 
        type === 'verifier' ? 'Capture Verifier Signature' : 'Capture Monitor Signature';
    
    const header = document.getElementById('signatureModalHeader');
    header.style.backgroundColor = type === 'verifier' ? '#0d6efd' : '#dc3545';
    header.style.color = 'white';
    
    clearSignature();
    new bootstrap.Modal(document.getElementById('signatureModal')).show();
    setTimeout(initSignatureCanvas, 300);
}

function saveSignature() {
    if (!signatureCanvas) return;
    
    const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
    let isBlank = true;
    for (let i = 0; i < imageData.data.length; i += 4) {
        if (imageData.data[i] < 250 || imageData.data[i+1] < 250 || imageData.data[i+2] < 250) {
            isBlank = false;
            break;
        }
    }
    
    if (isBlank) {
        alert('Please draw a signature first');
        return;
    }
    
    const signature = signatureCanvas.toDataURL('image/png');
    const endpoint = currentSignatureType === 'verifier' 
        ? '/api/operations/save-verifier-signature/'
        : '/api/operations/save-monitor-signature/';
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            company_id: currentSignatureCompanyId,
            signature: signature
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('signatureModal')).hide();
            const indicatorId = currentSignatureType === 'verifier' 
                ? `sig-indicator-${currentSignatureCompanyId}`
                : `monitor-sig-indicator-${currentSignatureCompanyId}`;
            const indicator = document.getElementById(indicatorId);
            if (indicator) indicator.style.display = 'inline';
            alert('Signature saved successfully');
        } else {
            alert('Error saving signature');
        }
    });
}

// ============================================
// CALENDAR VIEW (DRILLDOWN)
// ============================================
var currentDate = new Date();
var incompleteDays = window.incompleteDays || [];

function renderCalendar() {
    const monthYear = document.getElementById('calendar-month-year');
    const calendarBody = document.getElementById('calendar-body');
    
    if (!monthYear || !calendarBody) return;
    
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
    monthYear.textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    let html = '';
    
    // Empty cells before first day
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day empty"></div>';
    }
    
    // Days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = incompleteDays.find(d => d.date === dateStr);
        
        let classes = 'calendar-day';
        let content = `<div class="day-number">${day}</div>`;
        
        if (dayData) {
            content += '<div class="shift-badges">';
            
            // Pre-Op
            if (dayData.preop_verified) {
                content += '<span class="badge" style="background-color: #6f42c1;">Pre</span>';
            } else if (dayData.preop === true) {
                content += '<span class="badge bg-success">Pre</span>';
            } else if (dayData.preop === false) {
                content += '<span class="badge bg-warning text-dark">Pre</span>';
            } else {
                content += '<span class="badge bg-secondary">Pre</span>';
            }
            
            // Mid-Day
            if (dayData.midday_verified) {
                content += '<span class="badge" style="background-color: #6f42c1;">Mid</span>';
            } else if (dayData.midday === true) {
                content += '<span class="badge bg-success">Mid</span>';
            } else if (dayData.midday === false) {
                content += '<span class="badge bg-warning text-dark">Mid</span>';
            } else {
                content += '<span class="badge bg-secondary">Mid</span>';
            }
            
            // Post-Op
            if (dayData.postop_verified) {
                content += '<span class="badge" style="background-color: #6f42c1;">Post</span>';
            } else if (dayData.postop === true) {
                content += '<span class="badge bg-success">Post</span>';
            } else if (dayData.postop === false) {
                content += '<span class="badge bg-warning text-dark">Post</span>';
            } else {
                content += '<span class="badge bg-secondary">Post</span>';
            }
            
            content += '</div>';
            classes += ' clickable';
        }
        
        html += `<div class="${classes}" onclick="window.location.href='/operations/daily/?date=${dateStr}&company_id=${window.companyId}'">${content}</div>`;
    }
    
    // Empty cells after last day
    const remainingCells = (7 - ((firstDay + daysInMonth) % 7)) % 7;
    for (let i = 0; i < remainingCells; i++) {
        html += '<div class="calendar-day empty"></div>';
    }
    
    calendarBody.innerHTML = html;
}

function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar();
}

// ============================================
// FILTER FUNCTIONS (DRILLDOWN)
// ============================================
function setFilter(filter) {
    window.currentFilter = filter;
    
    const filters = ['incomplete', 'unverified', 'all'];
    filters.forEach(f => {
        const btn = document.getElementById('filter-' + f);
        if (btn) btn.classList.remove('active');
    });
    
    const activeBtn = document.getElementById('filter-' + filter);
    if (activeBtn) activeBtn.classList.add('active');
    
    const rows = document.querySelectorAll('.day-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const incomplete = row.dataset.incomplete === 'true';
        const unverified = row.dataset.unverified === 'true';
        
        let show = false;
        if (filter === 'all') show = true;
        else if (filter === 'incomplete') show = incomplete;
        else if (filter === 'unverified') show = unverified;
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    const emptyRow = document.getElementById('empty-row');
    if (emptyRow) emptyRow.style.display = visibleCount === 0 ? '' : 'none';
}

// ============================================
// SOP EDITOR
// ============================================
function openSOPEditor() {
    const select = document.getElementById('sop-company-select');
    select.innerHTML = '<option value="">-- Loading companies --</option>';
    
    const selectedCompanyId = window.currentSelectedCompanyId || '';
    
    fetch('/api/operations/get-companies/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                select.innerHTML = '<option value="">-- Select Company --</option>';
                data.companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    if (company.id == selectedCompanyId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Auto-load SOPs if company is pre-selected
                if (selectedCompanyId) {
                    loadSOPList();
                }
            } else {
                select.innerHTML = '<option value="">-- Error loading companies --</option>';
            }
        })
        .catch(error => {
            select.innerHTML = '<option value="">-- Error loading companies --</option>';
            console.error('Error fetching companies:', error);
        });
    
    new bootstrap.Modal(document.getElementById('sopEditorModal')).show();
}

function loadSOPList() {
    const companyId = document.getElementById('sop-company-select').value;
    if (!companyId) {
        document.getElementById('sop-tbody').innerHTML = '<tr><td colspan="10" class="text-center">Select a company to load SOPs</td></tr>';
        return;
    }
    
    // Load zones for filter dropdown
    fetch(`/api/operations/zones/?company_id=${companyId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) return;
            
            const filterSelect = document.getElementById('sop-zone-filter');
            const newSopZone = document.getElementById('new-sop-zone');
            
            filterSelect.innerHTML = '<option value="">All Zones</option>';
            newSopZone.innerHTML = '<option value="">-- Select Zone --</option>';
            
            data.zones.forEach(zone => {
                filterSelect.innerHTML += `<option value="${zone.id}">${zone.name}</option>`;
                newSopZone.innerHTML += `<option value="${zone.id}">${zone.name}</option>`;
            });
        });
    
    // Load SOPs
    fetch(`/api/operations/sop-list/?company_id=${companyId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) return;
            
            const tbody = document.getElementById('sop-tbody');
            if (data.sops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No SOPs found</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            data.sops.forEach(sop => {
                const startDate = sop.created_at ? sop.created_at.split('T')[0] : '';
                const row = document.createElement('tr');
                row.dataset.zoneId = sop.zone_id || '';
                row.innerHTML = `
                    <td>${sop.sop_did || ''}</td>
                    <td contenteditable="true" class="editable-cell" data-field="description" data-sop-id="${sop.sop_did}">${sop.description || ''}</td>
                    <td>${sop.zone_name || ''}</td>
                    <td><input type="date" class="form-control form-control-sm" value="${startDate}" onchange="updateSOPField(${sop.sop_did}, 'created_at', this.value)"></td>
                    <td class="text-center"><input type="checkbox" ${sop.pre ? 'checked' : ''} onchange="toggleSOPField(${sop.sop_did}, 'pre', this.checked)"></td>
                    <td class="text-center"><input type="checkbox" ${sop.mid ? 'checked' : ''} onchange="toggleSOPField(${sop.sop_did}, 'mid', this.checked)"></td>
                    <td class="text-center"><input type="checkbox" ${sop.post ? 'checked' : ''} onchange="toggleSOPField(${sop.sop_did}, 'post', this.checked)"></td>
                    <td class="text-center"><input type="checkbox" ${sop.input_required ? 'checked' : ''} onchange="toggleSOPField(${sop.sop_did}, 'input_required', this.checked)"></td>
                    <td class="text-center"><input type="checkbox" ${sop.image_required ? 'checked' : ''} onchange="toggleSOPField(${sop.sop_did}, 'image_required', this.checked)"></td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="deleteSOP(${sop.sop_did})"><i class="bi bi-trash"></i></button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add blur event for editable cells
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('blur', function() {
                    updateSOPField(this.dataset.sopId, this.dataset.field, this.textContent.trim());
                });
            });
        });
}

function filterSOPByZone() {
    const zoneId = document.getElementById('sop-zone-filter').value;
    const rows = document.querySelectorAll('#sop-tbody tr');
    
    rows.forEach(row => {
        if (!zoneId || row.dataset.zoneId === zoneId) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function toggleSOPField(sopId, field, checked) {
    fetch('/api/operations/sop-update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ sop_did: sopId, field: field, value: checked })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) alert('Error updating SOP');
    });
}

function updateSOPField(sopId, field, value) {
    fetch('/api/operations/sop-update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ sop_did: sopId, field: field, value: value })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) alert('Error updating SOP');
    });
}

function deleteSOP(sopId) {
    if (!confirm('Are you sure you want to delete this SOP?')) return;
    
    fetch('/api/operations/sop-delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ sop_did: sopId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) loadSOPList();
        else alert('Error: ' + (data.error || 'Failed to delete SOP'));
    });
}

function showAddSOPForm() {
    const companyId = document.getElementById('sop-company-select').value;
    if (!companyId) {
        alert('Please select a company first');
        return;
    }
    document.getElementById('add-sop-form').style.display = 'block';
    document.getElementById('add-zone-form').style.display = 'none';
}

function hideAddSOPForm() {
    document.getElementById('add-sop-form').style.display = 'none';
    document.getElementById('new-sop-description').value = '';
    document.getElementById('new-sop-zone').value = '';
    document.getElementById('new-sop-pre').checked = false;
    document.getElementById('new-sop-mid').checked = false;
    document.getElementById('new-sop-post').checked = false;
    document.getElementById('new-sop-input-required').checked = false;
    document.getElementById('new-sop-image-required').checked = false;
    const startDate = document.getElementById('new-sop-start-date');
    if (startDate) startDate.value = '';
}

function saveNewSOP() {
    const companyId = document.getElementById('sop-company-select').value;
    const description = document.getElementById('new-sop-description').value;
    const zoneId = document.getElementById('new-sop-zone').value;
    
    if (!zoneId) {
        alert('Please select a zone');
        return;
    }
    
    const startDateEl = document.getElementById('new-sop-start-date');
    
    fetch('/api/operations/sop-create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            company_id: companyId,
            description: description,
            zone_id: zoneId,
            pre: document.getElementById('new-sop-pre').checked,
            mid: document.getElementById('new-sop-mid').checked,
            post: document.getElementById('new-sop-post').checked,
            input_required: document.getElementById('new-sop-input-required').checked,
            image_required: document.getElementById('new-sop-image-required').checked,
            start_date: startDateEl ? startDateEl.value : null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideAddSOPForm();
            loadSOPList();
        } else {
            alert('Error: ' + (data.error || 'Failed to save SOP'));
        }
    });
}

function showAddZoneForm() {
    const companyId = document.getElementById('sop-company-select').value;
    if (!companyId) {
        alert('Please select a company first');
        return;
    }
    document.getElementById('add-zone-form').style.display = 'block';
    document.getElementById('add-sop-form').style.display = 'none';
    loadZoneList();
}

function hideAddZoneForm() {
    document.getElementById('add-zone-form').style.display = 'none';
    document.getElementById('new-zone-name').value = '';
}

function loadZoneList() {
    const companyId = document.getElementById('sop-company-select').value;
    fetch(`/api/operations/zones/?company_id=${companyId}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            const container = document.getElementById('zone-list');
            if (data.zones.length === 0) {
                container.innerHTML = '<p class="text-muted">No zones yet.</p>';
                return;
            }
            let html = '';
            data.zones.forEach(zone => {
                html += `<div class="d-flex align-items-center gap-2 mb-2" id="zone-row-${zone.id}">
                    <input type="text" class="form-control form-control-sm" value="${zone.name}" id="zone-name-${zone.id}" style="max-width: 250px;">
                    <span class="text-muted small">(${zone.sop_count} SOPs)</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="saveZoneName(${zone.id})"><i class="bi bi-check-lg"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteZone(${zone.id}, ${zone.sop_count})"><i class="bi bi-trash"></i></button>
                </div>`;
            });
            container.innerHTML = html;
        });
}

function saveZoneName(zoneId) {
    const name = document.getElementById('zone-name-' + zoneId).value.trim();
    if (!name) { alert('Zone name cannot be empty'); return; }
    
    fetch('/api/operations/zone-update/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ zone_id: zoneId, name: name })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) loadSOPList();
        else alert('Error: ' + (data.error || 'Failed to rename zone'));
    });
}

function deleteZone(zoneId, sopCount) {
    if (sopCount > 0) {
        alert(`Cannot delete zone â€” ${sopCount} SOPs are using it. Reassign them first.`);
        return;
    }
    if (!confirm('Delete this zone?')) return;
    
    fetch('/api/operations/zone-delete/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ zone_id: zoneId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) { loadZoneList(); loadSOPList(); }
        else alert('Error: ' + (data.error || 'Failed to delete zone'));
    });
}

function saveNewZone() {
    const companyId = document.getElementById('sop-company-select').value;
    const zoneName = document.getElementById('new-zone-name').value.trim();
    
    if (!zoneName) { alert('Please enter a zone name'); return; }
    
    fetch('/api/operations/zone-create/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ company_id: companyId, zone_name: zoneName })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('new-zone-name').value = '';
            loadZoneList();
            loadSOPList();
        } else {
            alert('Error: ' + (data.error || 'Failed to save zone'));
        }
    });
}

function printSOPSchedule() {
    const companyId = document.getElementById('sop-company-select').value;
    if (!companyId) {
        alert('Please select a company first');
        return;
    }
    window.open(`/operations/print-sop-schedule/?company_id=${companyId}`, '_blank');
}

// ============================================
// BULK REPORTS
// ============================================
var bulkCurrentDate = new Date();
var bulkCalendarData = {};
var selectedDays = new Set();

function openBulkReportModal() {
    selectedDays.clear();
    updateSelectedCount();
    
    const select = document.getElementById('bulk-report-company');
    select.innerHTML = '<option value="">-- Loading companies --</option>';
    
    const selectedCompanyId = window.currentSelectedCompanyId || '';
    
    fetch('/api/operations/get-companies/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                select.innerHTML = '<option value="">-- Select Company --</option>';
                data.companies.forEach(company => {
                    const selected = (company.id == selectedCompanyId) ? 'selected' : '';
                    select.innerHTML += `<option value="${company.id}" ${selected}>${company.name}</option>`;
                });
                
                // Auto-load calendar if company is pre-selected
                if (selectedCompanyId) {
                    loadBulkReportCalendar();
                }
            }
        });
    
    new bootstrap.Modal(document.getElementById('bulkReportModal')).show();
}

function loadBulkReportCalendar() {
    const companyId = document.getElementById('bulk-report-company').value;
    if (!companyId) {
        document.getElementById('bulk-calendar-body').innerHTML = '<div class="text-center text-muted p-4" style="grid-column: span 7;">Select a company</div>';
        return;
    }
    
    fetch(`/api/operations/get-calendar-data/?company_id=${companyId}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                bulkCalendarData = data.calendar_data;
                renderBulkCalendar();
            }
        });
}

function renderBulkCalendar() {
    const year = bulkCurrentDate.getFullYear();
    const month = bulkCurrentDate.getMonth();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
    
    document.getElementById('bulk-calendar-month-year').textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1).getDay();
    const totalDays = new Date(year, month + 1, 0).getDate();
    
    let html = '';
    
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="bulk-calendar-day empty"></div>';
    }
    
    for (let day = 1; day <= totalDays; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = bulkCalendarData[dateStr] || {};
        const hasCompleted = dayData.preop === true || dayData.midday === true || dayData.postop === true;
        const hasVerified = dayData.preop_verified || dayData.midday_verified || dayData.postop_verified;
        const isSelected = selectedDays.has(dateStr);
        
        let classes = 'bulk-calendar-day';
        if (isSelected) classes += ' selected';
        else if (hasVerified) classes += ' has-verified';
        else if (hasCompleted) classes += ' has-completed';
        if (!dayData.is_operating_day) classes += ' no-data';
        
        let badges = '<div class="day-badges">';
        if (dayData.preop_verified) badges += '<span class="badge" style="background-color: #6f42c1;">Pre</span>';
        else if (dayData.preop === true) badges += '<span class="badge bg-success">Pre</span>';
        else if (dayData.preop === false) badges += '<span class="badge bg-warning text-dark">Pre</span>';
        
        if (dayData.midday_verified) badges += '<span class="badge" style="background-color: #6f42c1;">Mid</span>';
        else if (dayData.midday === true) badges += '<span class="badge bg-success">Mid</span>';
        else if (dayData.midday === false) badges += '<span class="badge bg-warning text-dark">Mid</span>';
        
        if (dayData.postop_verified) badges += '<span class="badge" style="background-color: #6f42c1;">Post</span>';
        else if (dayData.postop === true) badges += '<span class="badge bg-success">Post</span>';
        else if (dayData.postop === false) badges += '<span class="badge bg-warning text-dark">Post</span>';
        badges += '</div>';
        
        const clickable = hasCompleted ? `onclick="toggleDaySelection('${dateStr}')"` : '';
        
        html += `<div class="${classes}" data-date="${dateStr}" ${clickable}>
            <div class="day-number">${day}</div>
            ${badges}
        </div>`;
    }
    
    const remainingCells = (7 - ((firstDay + totalDays) % 7)) % 7;
    for (let i = 0; i < remainingCells; i++) {
        html += '<div class="bulk-calendar-day empty"></div>';
    }
    
    document.getElementById('bulk-calendar-body').innerHTML = html;
}

function changeBulkMonth(delta) {
    bulkCurrentDate.setMonth(bulkCurrentDate.getMonth() + delta);
    renderBulkCalendar();
}

function toggleDaySelection(dateStr) {
    if (selectedDays.has(dateStr)) selectedDays.delete(dateStr);
    else selectedDays.add(dateStr);
    
    const el = document.querySelector(`.bulk-calendar-day[data-date="${dateStr}"]`);
    if (el) el.classList.toggle('selected');
    
    updateSelectedCount();
}

function selectAllDays() {
    Object.keys(bulkCalendarData).forEach(dateStr => {
        const dayData = bulkCalendarData[dateStr];
        if (dayData.preop_verified || dayData.midday_verified || dayData.postop_verified) {
            selectedDays.add(dateStr);
        }
    });
    renderBulkCalendar();
    updateSelectedCount();
}

function clearAllDays() {
    selectedDays.clear();
    renderBulkCalendar();
    updateSelectedCount();
}

function updateSelectedCount() {
    const count = selectedDays.size;
    document.getElementById('selected-days-count').textContent = `${count} day${count !== 1 ? 's' : ''} selected`;
    document.getElementById('generate-btn').disabled = count === 0;
}

function generateBulkReports() {
    const companyId = document.getElementById('bulk-report-company').value;
    const includeOperational = document.getElementById('include-operational').checked;
    const includeDeviations = document.getElementById('include-deviations').checked;
    
    if (!companyId || selectedDays.size === 0) {
        alert('Please select a company and at least one day');
        return;
    }
    
    if (!includeOperational && !includeDeviations) {
        alert('Please select at least one report type');
        return;
    }
    
    const dates = Array.from(selectedDays).sort();
    const params = new URLSearchParams({
        company_id: companyId,
        dates: dates.join(','),
        include_operational: includeOperational ? '1' : '0',
        include_deviations: includeDeviations ? '1' : '0'
    });
    
    window.open(`/operations/bulk-report/?${params.toString()}`, '_blank');
}

// ============================================
// INITIALIZE ON PAGE LOAD
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    initSignatureCanvas();
    
    // Initialize calendar tab listener if present
    const calendarTab = document.getElementById('calendar-tab');
    if (calendarTab) {
        calendarTab.addEventListener('shown.bs.tab', function() {
            renderCalendar();
        });
    }
});
</script>

<style>
/* Calendar styles */
.calendar-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 10px;
    font-weight: bold;
    text-align: center;
}

.calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}

.calendar-day {
    min-height: 80px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 5px;
    background: white;
    cursor: pointer;
}

.calendar-day:hover {
    background: #f8f9fa;
}

.calendar-day.empty {
    background: #f8f9fa;
    border-color: #e9ecef;
    cursor: default;
}

.calendar-day.clickable {
    cursor: pointer;
}

.day-number {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
}

.shift-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
}

.shift-badges .badge {
    font-size: 0.65em;
    padding: 2px 4px;
}

.calendar-legend {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    border: 1px solid #dee2e6;
}

/* Bulk Calendar styles */
.bulk-calendar-container {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.bulk-calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    font-weight: bold;
    text-align: center;
    padding: 8px 0;
}

.bulk-calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.bulk-calendar-day {
    min-height: 70px;
    border: 1px solid #eee;
    padding: 4px;
    cursor: default;
}

.bulk-calendar-day.empty {
    background-color: #f8f9fa;
}

.bulk-calendar-day.no-data {
    background-color: #f8f9fa;
    opacity: 0.6;
}

.bulk-calendar-day.has-completed {
    background-color: #d4edda;
    cursor: pointer;
}

.bulk-calendar-day.has-verified {
    background-color: #e2d9f3;
    cursor: pointer;
}

.bulk-calendar-day.selected {
    background-color: #0d6efd !important;
    color: white;
}

.bulk-calendar-day .day-number {
    font-weight: bold;
    margin-bottom: 4px;
}

.bulk-calendar-day .day-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
}

.bulk-calendar-day .day-badges .badge {
    font-size: 0.65em;
    padding: 2px 4px;
}

/* Signature canvas */
#signatureCanvas {
    border: 2px solid #000;
    border-radius: 4px;
    cursor: crosshair;
    touch-action: none;
}
</style>